odoo.define("medical_js.calendar",function(require){"use strict";var t=require("medical_js.BaseWidget"),
    r=require("web.core"),
    i=require("web.utils"),
    n=require("web.session"),
    a=require("web.field_utils");
    t.Chrome;var o=t.gui,s=t.screens,c=r.qweb,d=r._t;i.round_precision;var l=s.ScreenWidget.extend({template:"CalendarScreenWidget",getResources:function(){return this.medical.current_clinic.resources},getColor:function(e){var t=_.findWhere(this.medical.db.states_by_id,{name:e});return t&&t.s_color||"#FFF"},getResourceTimeOff:function(e){var t=this.medical.config;return this._rpc({model:"medical.config",method:"get_resource_timeoff",args:[[t.id],this.format_server_date(e)]})},_recordToCalendarEvent:function(e){var t,r=this.toUserTZ(new Date(e.start_time)),i=this.toUserTZ(new Date(e.end_time));return e.start_time=r,e.end_time=i,t=moment()>r&&"draft"==e.state?this.getColor("late"):this.getColor(e.state),_.isEmpty(e.partner_id)||(e.partner=this.medical.db.get_partner_by_id(e.partner_id[0])),e.state_display=this.state_display[e.state],{record:e,start:r,end:i,title:this.parseM2o(e.partner_id).display_name,allDay:!1,id:e.id,resourceId:this.parseM2o(e.resource_id).id,state:e.state,state_display:e.state_display,backgroundColor:t}},parseBackgroundEvents:function(e){var t=this,r=[],i={};return _.each(e,function(e){var n=t.toUserTZ(new Date(e.date_from)),a=t.toUserTZ(new Date(e.date_to)),o=e.resource_id;e.start_time=n,e.end_time=a;var s={record:e,start:n,end:a,title:e.name||"",resourceId:o,allDay:!1,overlap:!1,id:e.id,display:"background",event_type:"timeoff"};-1==_.indexOf(_.keys(i),o)?i[o]=[[n,a]]:i[o].push([n,a]),r.push(s)}),t.bg_event_by_resource_id=i,r},searchedEvent:function(e){var t=this.search_on,r=this.search_text,i="all"==this.search_state?"":this.search_state;if(t&&r){var n=!0;if("apmt_name"==t)e.name.toLowerCase().includes(r)||(e.passport_no||"").toLowerCase().includes(r)||(n=!1);else if("invoice_ref"==t)(e.invoice_number||"").toLowerCase().includes(r)||(n=!1);else if("patient_name"==t){if(e.partner_id){var a=e.partner_id[1],o=e[this.get_config_file_key()];(a||"").toLowerCase().includes(r)||(o||"").toLowerCase().includes(r)||(n=!1)}else n=!1}else if("patient_phone_mobile_civil"==t){if(e.partner_id){var s=this.medical.db.get_partner_by_id(e.partner_id[0]);(s.mobile||"").toLowerCase().includes(r)||(s.phone||"").toLowerCase().includes(r)||(s.passport_no||"").toLowerCase().includes(r)||(s.civil_code||"").toLowerCase().includes(r)||(n=!1)}else n=!1}if(n&&i&&(n=e.state==i),!n)return!1}else if(i&&e.state!=i)return!1;return!0},parseRecordsToEvents:function(e){for(var t=this,r=[],i=[],n=0;n<e.length;n++){var a=e[n];if(t.searchedEvent(a)){var o=t._recordToCalendarEvent(a);r.push(o),i[o.resourceId]||(i[o.resourceId]=[]),i[o.resourceId].push(o)}}return t.events_by_resource_id=i,r},start:function(){this._super.apply(this,arguments),this.timing_of_rooms={},this.global_view_init=!1,this.bg_event_block_slots={},this.bg_event_by_resource_id={},this._initCalendar()},show:function(){this._super(),this.renderCalendar(),this.calendar.refetchEvents(),this.renderSearchBar(!0)},hide:function(){this._super(),this.renderSearchBar()},renderSearchBar:function(e){var t=this;if(e){this.search_on="apmt_name",this.search_state="all",this.search_text="";var r=$(".v-top-right");0==r.children(".apmt-searchbox").length?(r.prepend(c.render("Session.SearchAppointment",{states:t.state_display})),r.off("keyup",".apmt-search-text"),r.on("keyup",".apmt-search-text",function(e){t.search_text=this.value&&this.value.toLowerCase()||"",t.search_text.length>=2&&t.calendar.refetchEvents()}),r.off("change",".apmt-search-on, .apmt-search-state"),r.on("change",".apmt-search-on",function(e){t.search_on=this.value,t.search_text.length>=2&&t.calendar.refetchEvents()}),r.on("change",".apmt-search-state",function(e){t.search_state=this.value,t.calendar.refetchEvents()}),r.off("click",".search-clear"),r.on("click",".search-clear",function(e){r.find(".apmt-search-text").val(""),r.find(".apmt-search-state option:eq(0)").prop("selected","selected"),t.search_text="",t.search_state="all",t.calendar.refetchEvents()})):$(".apmt-searchbox").show()}else $(".apmt-searchbox").hide()},renderCalendar:function(){this.calendar.render()},getEvents:function(e,t,r){var i=this,n=this.medical.current_clinic&&this.medical.current_clinic.id||!1;return this.medical.reloadEvents(e,t,r,n).then(function(e){return i.medical.db.add_partners(e.partners),i.parseRecordsToEvents(e.orders)})},prepareResourceBlockedEvents:function(e,t){var r=this,i=this.format_server_date(this.calendar.getDate()),n=[],a=this.chrome.medical.get_clinic()||{};if(r.bg_event_block_slots){if(r.bg_event_block_slots[a.id]){if(r.bg_event_block_slots[a.id][e.id]){if(_.indexOf(_.keys(r.bg_event_block_slots[a.id][e.id]),i)>=0)return}else r.bg_event_block_slots[a.id][e.id]={}}else r.bg_event_block_slots[a.id]={},r.bg_event_block_slots[a.id][e.id]={}}else r.bg_event_block_slots[a.id]={},r.bg_event_block_slots[a.id][e.id]={};if(e&&t&&t.length){var o=i+" 00:00:00",s=i+" 23:59:59";t=_.sortBy(t,"hour_from");var c=0;_.each(t,function(a){c+=1,s=i+" "+r.floatToHour(a.hour_from)+":00";var d={record:{},start:new Date(o),end:new Date(s),title:"",resourceId:e.id,allDay:!1,overlap:!1,id:_.uniqueId("slot_"),display:"background",event_type:"slot",backgroundColor:"gray"};if(n.push(d),t.length==c){o=i+" "+r.floatToHour(a.hour_to)+":00",s=i+" 23:59:59";var d={record:{},start:new Date(o),end:new Date(s),title:"",resourceId:e.id,allDay:!1,overlap:!1,id:_.uniqueId("slot_"),display:"background",event_type:"slot",backgroundColor:"gray"};n.push(d)}else o=i+" "+r.floatToHour(a.hour_to)+":00"})}else{var o=i+" 00:00:00",s=i+" 23:59:59",d={record:{},start:new Date(o),end:new Date(s),title:"",resourceId:e.id,allDay:!1,overlap:!1,id:_.uniqueId("slot_"),display:"background",event_type:"slot",backgroundColor:"gray"};n.push(d)}r.bg_event_block_slots[a.id][e.id][i]=t,r.calendar.addEventSource(n)},getTooltip:function(e){return c.render("EventTooltip",{record:e,widget:this})},getCalendarOptions:function(){var e=this,t=this.gui.medical.config;e.search_on="apmt_name",e.search_text="",e.search_state="all";var r=[{events:function(t,r,i){e.getEvents(t.start,t.end,t.timezone).then(function(e){e=e||[],console.log("___ Appointments Fetched : ",e.length),r(e)})}}];t.allow_time_off&&r.push({events:function(t,r,i){e.getResourceTimeOff(e.get_server_datetime(t.end)).then(function(t){t=t||[],t=e.parseBackgroundEvents(t),console.log("___ TimeOff Fetched : ",t.length,t),r(t)})},color:"gray",textColor:"red",display:"background"});var i=t.calendar_views||"resourceTimeGridDay,resourceTimeline,resourceTimeGridWeek,dayGridMonth,listDay,listMonth",n=t.calendar_default_view||"resourceTimeGridDay",o="00:15:00";return t.calendar_slot_duration&&(o="00:"+t.calendar_slot_duration+":00"),{schedulerLicenseKey:t.calendar_license_key,customButtons:{btnRefresh:{click:function(t){e.calendar.refetchEvents()}},btnGotoDate:{click:function(t){var r=$(t.target);r.datetimepicker("destroy"),r.datetimepicker(e.dt_picker_options),r.datetimepicker("show").change(function(){var t=e.to_moment(this.value,"","DD/MM/YYYY");e.gotoDate(t._d)})}},btnPrint:{click:function(e){window.print()}},btnCreateNew:{click:function(t){var r=e.getCurrentDate(),i=e.getResources();console.log("_ ev : ",t,r,i),e.appointment_dateClick(this,{resource:i&&i[0]||!1,date:r})}}},themeSystem:"bootstrap",initialView:n,headerToolbar:{left:"prev,btnRefresh,next btnGotoDate,today,btnPrint,btnCreateNew",center:"title",right:i},bootstrapFontAwesome:{btnRefresh:"fa-refresh",btnGotoDate:"fa-calendar",btnPrint:"fa-print",btnCreateNew:"fa-plus"},contentHeight:"auto",allDaySlot:!1,defaultTimedEventDuration:o,views:{dayGridMonth:{buttonText:"Month"},dayGridWeek:{buttonText:"Week"},dayGridDay:{buttonText:"Day"},dayGrid:{buttonText:"Day"},timeGridWeek:{buttonText:"Week"},timeGridDay:{buttonText:"Day"},timeGrid:{buttonText:"Day"},listYear:{buttonText:"Year List"},listMonth:{buttonText:"Month List"},listWeek:{buttonText:"Week List"},listDay:{buttonText:"Day List"},list:{buttonText:"Day List"},timelineYear:{buttonText:"Year Timeline"},timelineMonth:{buttonText:"Month Timeline"},timelineWeek:{buttonText:"Week Timeline"},timelineDay:{buttonText:"Day Timeline"},timeline:{buttonText:"Timeline"},resourceDayGridMonth:{buttonText:"Resource Day Month"},resourceDayGridWeek:{buttonText:"Resource Day Week"},resourceDayGridDay:{buttonText:"Resource Day"},resourceDayGrid:{buttonText:"Resource Day "},resourceTimeGridWeek:{buttonText:"Week"},resourceTimeGridDay:{buttonText:"Day"},resourceTimeGrid:{buttonText:"Day"},resourceTimelineYear:{buttonText:"Timeline By Year"},resourceTimelineMonth:{buttonText:"Timeline By Month"},resourceTimelineWeek:{buttonText:"Timeline By Week"},resourceTimelineDay:{buttonText:"Timeline By Day"},resourceTimeline:{buttonText:"Timeline"}},slotDuration:o,slotEventOverlap:!!t.calendar_slotEventOverlap,slotLabelFormat:"h:mm a",lazyFetching:!0,selectable:!0,listDaySideFormat:!1,noEventsContent:d("No Appointment to Display"),nowIndicator:!0,timeZoneParam:e.user_timezone,height:"auto",dayMinWidth:150,scrollTime:a.format.float_time(t.start_time||"09:00"),slotMinTime:a.format.float_time(t.start_time||"09:00"),slotMaxTime:a.format.float_time(t.end_time||"16:00"),buttonIcons:!0,firstDay:6,locale:"en",titleFormat:"ddd, D MMMM YYYY",weekends:!0,initialDate:new Date,droppable:!0,navLinks:!0,editable:!0,resourceOrder:"sequence",datesAboveResources:!1,dayMaxEvents:!1,eventBorderColor:"black",eventTextColor:"black",eventBackgroundColor:"white",eventDurationEditable:!0,eventOverlap:!0,expandRows:!0,displayEventTime:!0,forceEventDuration:!0,eventSources:r,initialResources:function(t,r,i){r(e.getResources())},resourceLabelContent:function(t){var r=e.medical.resource_by_id[parseInt(t.resource.id)],i="",n=[];if(r){var a=e.prepareResourceTiming(r);n=a[1]||[],i=c.render("Calendar.ResourceTitle",{resource:r,timing_str:a[0]})}return e.prepareResourceBlockedEvents(r,n),{html:i}},eventContent:function(e){var t=e.event;if("background"==t.display&&!_.isEmpty(t.title))return{html:'<div class="text-center" style="color: white;"> <strong>Time Off</strong><br />'+t.title+"</div>"}},eventDidMount:function(t){var r=t.event;if("background"!=r.display&&"inverse-background"!=r.display){var i=$(t.el),n=t.view.type,a=r.extendedProps.record,o="",s=this.medical.get_file_no(a);e.show_file_no_first&&s&&(o+='<span class="font-italic font-weight-bold mr-1">'+s+"</span>"),a&&a.visit_type&&"pre_app"==a.visit_type&&(o+='<span class="fa fa-link mr-1" style="color: cyan" />'),o&&i.find(".fc-event-title").prepend(o);var d='<ul class="p-0 pl-3 services">';if(_.each(a.order_lines,function(e){d+="<li>"+e.product_id[1]+"</li>"}),d+="</ul>",i.find(".fc-event-title").after($(d)),a.employee_id&&a.employee_id.length){var l='<strong><span class="fa fa-id-badge ml-1" /> '+a.employee_id[1]+"</strong>";i.find(".services").after($(l))}if("listDay"==n||"listMonth"==n){var u=a.resource_id&&a.resource_id[1]||"";i.find(".fc-list-event-title").after("<td>"+u+"</td><td>"+a.state_display+"</td>")}new Tooltip(t.el,{title:function t(){return c.render("EventTooltip",{record:a,widget:e})},placement:"right",trigger:"hover",container:"body"})}},eventClick:function(t){e.appointment_eventClick(this,t)},eventResize:function(t){if(!confirm("Are you sure about this change ?")){t.revert();return}var r=t.event,i=parseInt(r.id),n=moment(r.end).diff(moment(r.start),"minutes")/60;return e._rpc({model:"medical.order",method:"write",args:[[i],{extra_time:n}]})},eventDrop:function(t){console.log("___ eventDrop : ",t);var r,i=t.event;if(e.validate_appointment_booking(i.start)){var n=i.extendedProps.record,a=parseInt(n.resource_id[0]),o={start_time:e.get_server_datetime(i.start)};if(t.newResource&&(a=parseInt(t.newResource.id))&&(o.resource_id=a),t.oldResource){var s=parseInt(t.oldResource.id);a&&(o.old_resource_id=s)}var c=e.timing_of_rooms[a];if(!e.validate_resource_time(c,i.start,a)){e.chrome.do_notify(d("Resource Time Exceeded")),t.revert();return}var l="";if("pre_app"==n.visit_type&&(l="This is Requested Appointment. \n"),confirm(l+"Are you sure about this change?"))e.chrome.blockUI(),(r=i.extendedProps.line_id?e._rpc({model:"medical.order.line",method:"update_appointment_resource",args:[[i.extendedProps.line_id],o]}):e._rpc({model:"medical.order",method:"update_appointment_resource",args:[[n.id],o]})).then(function(){e.calendar.refetchEvents(),e.chrome.unblockUI()}).guardedCatch(function(t){console.error("_ error : ",t),e.chrome.unblockUI()});else{t.revert();return}}},dateClick:function(t){console.log("___ dateClick : ",t),e.appointment_dateClick(this,t)},loading:function(t){!t&&e.gui&&e.gui.current_screen&&e.gui.current_screen.calendar&&!e.global_view_init&&this.view&&(e.global_view_init=!0,e.renderResourceEventCount(this.view.type,$(this.el)),e.bindResourceEventCountPrint())},viewDidMount:function(t){var r=t.view.type;r&&("listDay"==r||"listMonth"==r?e.addListViewHeader($(t.el)):e.global_view_init&&e.renderResourceEventCount(r,$(t.el)))}}},getListViewHeader:function(){var e;return"<thead><th /><th /><th>"+this.label_list.partner_id+"</th><th>Contact</th><th>"+this.label_list.resource_id+"</th><th>State</th></thead>"},addListViewHeader:function(e){e.find(".fc-list-table thead").length&&e.find(".fc-list-table thead").remove();var t=this.getListViewHeader();e.find(".fc-list-table").prepend(t)},_initCalendar:function(){var e=this.$("#full_calendar_widget")[0];this.calendar=new FullCalendar.Calendar(e,this.getCalendarOptions())},gotoDate:function(e){this.calendar.gotoDate(e)},getCurrentDate:function(){return this.calendar.getDate()},renderResourceEventCount:function(e,t){if("listDay"!=e&&"listMonth"!=e){var r=this,i=t.find(".v-resource");_.each(_.keys(r.events_by_resource_id),function(e){var e=parseInt(e),t='.v-resource-print[data-resource="'+e+'"]',n=i.find(t),a=(r.events_by_resource_id[e]||[]).length;n.length&&a&&n.find(".v-event-count-by-resource").html(a)})}},bindResourceEventCountPrint:function(){var e=this;this.$el.delegate(".v-resource-print","click",function(t){t.stopPropagation();var r=e.getCurrentDate();r=moment(r).format(e.chrome.date_server_format);var i=$(this).data("resource"),n=e.medical.resource_by_id[i].name;e.chrome.print_custom_reports("/medical/report",{report_model:"report.medical_js.medical_resource_report_template",report_tag_id:"medical_js.appointment_resource_details_report",filename:n+" - "+r+" - Appointments"},{resource_ids:[i],date_start:r,date_stop:r})})},appointment_eventClick:function(e,t,r){var i=this;return n.rpc("/event",{order_id:t.event.id}).then(function(e){console.log("___ Opening Appointment : ",e),i.gui.show_popup("popup-appointment-details",{order:e,title:e.name,widget:i,calendar:i,cancel:function(){i.gui.show_screen("calendar",{calendar:i.calendar},"refresh")}})})},validate_appointment_booking:function(e){if(this.medical.config.restrict_prev_date_appointment){var t=moment(e).startOf("day");if(moment(e).startOf("day").isBefore(moment(),"day"))return console.log("___ Not Allowed Previous Date Appointment : now, ",t,e),this.chrome.error_toast(d("You cannot book an appointment on previous date.")),!1}return!0},get_clicked_resource:function(e){if("pcr"==this.medical.config.company_code||"file_no2"==this.medical.config.depends_on){var t=e.resource;if(!t)return;return t}return{}},appointment_dateClick:function(e,t){var r=this,i=this.get_clicked_resource(t),n=!1;_.isEmpty(i)||(n=Number(i.id));var a=t.date,o=this.medical.chrome.getUTC(a);if(this.validate_appointment_booking(a)){if(n){var s=r.timing_of_rooms[i.id];if(!r.validate_resource_time(s,a,n)){console.log("___ Time Exceeded: timing_of_resource, date : ",s,a),r.chrome.error_toast(d("Resource Time Exceeded"));return}if(!r.medical.calendar_slotEventOverlap&&r.isDateHasEvent(a,i.id)){r.chrome.error_toast(d("Resouce is already occupied for selected time."));return}}var c={},l=!1;if(r.medical.duplicate_order||r.medical.move_order||r.medical.waiting_to_appointment){var u=(c=r.medical.get_order()).get_client();r.partner_id=u&&u.id,r.medical.waiting_to_appointment=!1}else if(r.medical.from_partner_screen){r.medical.from_partner_screen=!1;var h=(c=r.medical.get_order()).get_screen_data("params"),u=h&&h.partner||{};if(r.partner_id=u.id,!_.isEmpty(i)&&u.blocked_doctor_ids.length&&_.contains(u.blocked_doctor_ids,parseInt(i.id))){console.warn("___  : ",u.blocked_doctor_ids,i.id,i,u),r.chrome.warning_toast("Patient `"+(u.name||"")+"` is blocked by selected doctor.");return}c=r.medical.add_new_order()}else c=r.medical.add_new_order({default_screen:"calendar"}),r.partner_id=!1;if(c.set_start_time(o),r.partner_id&&(l=r.medical.db.get_partner_by_id(r.partner_id),c.set_client(l)),_.isEmpty(i)||c.set_resource_id(i.id),r.medical.duplicate_order||r.medical.move_order){if(r.medical.duplicate_order=!1,r.medical.move_order=!1,!_.isEmpty(i)){var m=r.medical.resource_by_id[i.id];if(m&&m.hr_staff_id&&m.hr_staff_id.length){var f=m.hr_staff_id[0];_.each(c.get_orderlines(),function(e){e.set_line_employee_id(f),e.set_multi_data(i.id,a)})}}r.gui.screen_instances.appointment.sync_appointment(c).then(function(){r.chrome.unblockUI(),r.calendar.refetchEvents()});return}if(!l){r.gui.show_screen("patient_list",{back_screen:"appointment",set_customer:!0});return}this.gui.show_screen("appointment",{order:c,dateClickInfo:t})}},isDateHasEvent:function(e,t){var r=[];r=this.calendar.getEvents();var i=e,n=moment(e).add(this.medical.config.slot_duration,"m");return $.grep(r,function(e){return e.resourceId==t&&e.start<n&&e.end>i}).length>0},prepareResourceTiming:function(e){if(!e)return["",[]];var t=this,r="",i=[],n=this.format_server_date(this.calendar.getDate()),a=this.chrome.medical.get_clinic()||{};if(!_.isEmpty(this.bg_event_block_slots[a.id])&&!_.isEmpty(this.bg_event_block_slots[a.id][e.id])&&!_.isEmpty(this.bg_event_block_slots[a.id][e.id][n])){var o=this.bg_event_block_slots[a.id][e.id][n],r=this.prepareResourceTimingContent(o);return[r,o]}var s=e.working_hour_id&&e.working_hour_id.length&&e.working_hour_id[0];if(s||(s=t.medical.config.working_hour_id&&t.medical.config.working_hour_id.length&&t.medical.config.working_hour_id[0]),s){var c=t.medical.calendar_by_id[s],d=t.calendar.getDate(),l=moment(d),u=d.getDay()-1,u=-1==u&&6||u;function h(e,t){return e&&t?l.isBetween(e,t,void 0,"[]")?1:-1:!e&&t?l.isSameOrBefore(t,"day")?2:-2:!e||t?4:l.isSameOrAfter(e,"day")?3:-3}for(var m=_.filter(c.attendances,function(e){return parseInt(e.dayofweek)==u}),f=0;f<m.length;f++){var p=m[f];(!p.branch_id||!a||p.branch_id[0]==a.id)&&h(p.date_from,p.date_to)>0&&i.push(p)}r=this.prepareResourceTimingContent(i),t.timing_of_rooms[e.id]=i}return[r,i]},prepareResourceTimingContent:function(e){var t=this,r=0,i="";return e&&e.length>0&&_.each(e,function(n){r+=1,i+=t.floatToHour(n.hour_from),n.hour_to&&(i+=" - "+t.floatToHour(n.hour_to)),r!=e.length&&(i+="<br />")}),i},validate_resource_time:function(e,t,r){var i=!1,e=e||[],n=this.bg_event_by_resource_id;if(!e.length&&_.isEmpty(n))return!this.medical.config.strict_working_schedule;for(var a,o=moment(t),s=(a=o).format("YYYY")+"-"+a.format("M")+"-"+a.format("D"),c=0;c<e.length;c++){var d=this.floatToHour(e[c].hour_from),l=this.floatToHour(e[c].hour_to),u=moment(s+" "+d,"YYYY-M-D H:mm"),h=moment(s+" "+l,"YYYY-M-D H:mm");if(o.isBetween(u,h,null,"[)")){i=!0;break}}if(i&&this.medical.config.allow_time_off&&!_.isEmpty(this.bg_event_by_resource_id[r]))for(var m=this.bg_event_by_resource_id[r],c=0;c<m.length;c++){var f=m[c];if(o.isBetween(moment(f[0]),moment(f[1]),null,"[)")){i=!1;break}}return i},closestTime:function(e){var t=["00"],r=this.medical.config.slot_duration;15==r?t=["00",20,15,30,45]:"30"==r&&(t=["00",30]);for(var i=t[0],n=Math.abs(e-i),a=0;a<t.length;a++){var o=Math.abs(e-t[a]);o<n&&(n=o,i=t[a])}return i}});o.define_screen({name:"calendar",widget:l});var u=t.MenuButtonWidget.extend({template:"BtnCalendarScreen",button_click:function(){this.gui.show_screen("calendar")}});return t.define_menu_button({name:"btn_show_calendar",widget:u}),l});