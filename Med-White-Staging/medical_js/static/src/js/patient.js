odoo.define("medical_js.patient",function(require){"use strict";var t=["name","card_no","card_balance","balance"],
    i=["name","journal_id","payment_date","amount","payment_balance","state"],
    n=require("medical_js.BaseWidget"),
    a=require("web.core"),
    r=require("web.rpc"),
    s=require("web.utils");require("web.session"),
    require("web.field_utils"),
    n.Chrome;var o=n.gui,c=n.screens,l=a.qweb,d=a._t;s.round_precision;var h=n.PopupWidget.extend({},{template:"PopupCivilExist",events:_.extend({},n.PopupWidget.prototype.events,{"click .open":function(){this.medical.gui.current_screen.display_client_details("edit",this.options.partner,0),this.gui.close_popup()},"click .overwrite":function(){var e=this;e.medical.gui.current_screen.display_client_details("edit",this.options.partner,0),setTimeout(function(){console.log("_ self.options.data : ",e.options.data),e.options.parent.renderData(e.options.data),e.gui.close_popup()},10)}}),show:function(){this._super.apply(this,arguments)},renderElement:function(){this._super.apply(this,arguments)}});o.define_popup({name:"popup-civil-exist",widget:h});var p=a.Class.extend({init:function(e){e=e||{},this.max_size=e.max_size||2e3,this.cache={},this.access_time={},this.size=0},cache_node:function(e,t){var i=this.cache[e];if(this.cache[e]=t,this.access_time[e]=new Date().getTime(),!i)for(this.size++;this.size>=this.max_size;){var n=null,a=new Date().getTime();for(e in this.cache){var r=this.access_time[e];r<=a&&(a=r,n=e)}n&&(delete this.cache[n],delete this.access_time[n]),this.size--}return t},clear_node:function(e){this.cache[e]&&(delete this.cache[e],delete this.access_time[e],this.size--)},get_node:function(e){var t=this.cache[e];return t&&(this.access_time[e]=new Date().getTime()),t}}),u=c.ScreenWidget.extend({template:"ClientListScreenWidget",init:function(e,t){this._super(e,t),this.partner_cache=new p,this.integer_client_details=["country_id","state_id","property_product_pricelist","parent_id","nationality_id"]},auto_back:!0,show:function(){var e=this;this._super(),this.renderElement(),this.details_visible=!1,this.old_client=this.medical.get_order().get_client(),this.set_customer=this.gui.get_current_screen_param("set_customer"),this.$(".back").click(function(){e.gui.back()}),this.$(".next").click(function(){e.select_patient()}),this.$(".new-customer").click(function(){e.display_client_details("edit",{country_id:e.medical.company.country_id,state_id:e.medical.company.state_id})});var t=this.medical.db.get_partners_sorted(1e3);this.render_list(t),this.reload_partners(),this.old_client&&this.display_client_details("show",this.old_client,0),this.$(".client-list-contents").on("click",".client-line",function(t){e.line_select(t,$(this),parseInt($(this).data("id")))}),this.medical.config.iface_vkeyboard&&this.chrome.widget.keyboard&&this.chrome.widget.keyboard.connect(this.$(".searchbox input")),this.$(".searchbox input").on("keypress",function(t){clearTimeout(null),e.search_deep()}),this.$(".searchbox .search-clear").click(function(){e.clear_search()}),this.$(".searchbox .search-more").click(function(){e.search_deep()})},select_patient:function(){var e=this.label_list.partner_id;if(this.new_client){var t=this.medical.get_order().resource_id;if(t&&_.contains(this.new_client.blocked_doctor_ids,t)){this.gui.show_popup("error",{title:d("Restriction"),body:d("A "+e+" is blocked by Doctor")});return}var i=this.medical.company.max_apmt_cancel,n=this.medical.company.max_apmt_no_show,a=this.new_client.app_cancelled_count,r=this.new_client.app_no_show_count;i&&n&&(a>=i||r>=n)&&this.chrome.warning_toast(_(e+" is reached limitation of max Cancellation/No Show."))}if(this.save_changes(),this.set_customer){this.gui.show_screen("appointment");return}this.gui.back()},search_deep:function(){var e=this,t=this.$(".searchbox input")[0].value;if(t){var i=_.findWhere(this.medical.models,{model:"res.partner"}),n=i.domain.slice(),a=this.get_config_file_key();switch(this.$(".partner-search-on").val()){case"filename":n.push([a,"ilike",t]);break;case"name":n.push("|",["name","ilike",t],["ar_name","ilike",t]);break;case"phone":n.push(["phone","ilike",t]);break;case"mobile":n.push(["mobile","ilike",t]);break;case"civil_id":n.push(["civil_code","ilike",t]);break;case"card_no":n.push(["prepaid_card_ids.card_no","=",t]);break;default:n.push("|","|","|","|","|","|","|","|",["name","ilike",t],["ar_name","ilike",t],["passport_no","=",t],["phone","ilike",t],["mobile","ilike",t],[a,"ilike",t],["email","ilike",t],["civil_code","ilike",t],["city","ilike",t])}this._rpc({model:"res.partner",method:"search_read",context:i.context,domain:n,fields:i.fields}).then(function(t){e.medical.db.add_partners(t),e.render_list(t)})}},hide:function(){this._super(),this.new_client=null},barcode_client_action:function(e){if(this.editing_client)this.$(".detail.barcode").val(e.code);else if(this.medical.db.get_partner_by_barcode(e.code)){var t=this.medical.db.get_partner_by_barcode(e.code);this.new_client=t,this.display_client_details("show",t)}},perform_search:function(e,t){var i;e?(i=this.medical.db.search_partner(e),this.display_client_details("hide"),t&&1===i.length&&(this.new_client=i[0],this.save_changes(),this.gui.back()),this.render_list(i)):(i=this.medical.db.get_partners_sorted(),this.render_list(i))},clear_search:function(){var e=this.medical.db.get_partners_sorted(1e3);this.render_list(e),this.$(".searchbox input")[0].value="",this.$(".searchbox input").focus()},render_list:function(e){console.log("Render List is called and Partner is : ",e);var t=this.$el[0].querySelector(".client-list-contents");t.innerHTML="";for(var i=0,n=Math.min(e.length,1e3);i<n;i++){var a=e[i],r=this.partner_cache.get_node(a.id);if(!r){var s=l.render("ClientLine",{widget:this,partner:e[i]}),r=document.createElement("tbody");r.innerHTML=s,r=r.childNodes[1],this.partner_cache.cache_node(a.id,r)}a===this.old_client?r.classList.add("highlight"):r.classList.remove("highlight"),t.appendChild(r)}},save_changes:function(){var e=this.medical.get_order();if(this.has_client_changed()){if(this.medical.config.fiscal_position_id){var t,i=_.findWhere(this.medical.fiscal_positions,{id:this.medical.config.fiscal_position_id[0]});this.new_client?(this.new_client.property_account_position_id&&(t=_.findWhere(this.medical.fiscal_positions,{id:this.new_client.property_account_position_id[0]})),e.fiscal_position=t||i,e.set_pricelist(_.findWhere(this.medical.pricelists,{id:this.new_client.property_product_pricelist[0]})||this.medical.default_pricelist)):(e.fiscal_position=i,e.set_pricelist(this.medical.default_pricelist))}e.set_client(this.new_client)}},has_client_changed:function(){return this.old_client&&this.new_client?this.old_client.id!==this.new_client.id:!!this.old_client!=!!this.new_client},toggle_save_button:function(){var e=this.$(".btn.next");if(this.editing_client){e.addClass("oe_hidden");return}this.new_client?this.old_client?e.text(d("Change Customer")):e.text(d("Set Customer")):e.text(d("Deselect Customer")),e.toggleClass("oe_hidden",!this.has_client_changed())},line_select:function(e,t,i){var n=this.medical.db.get_partner_by_id(i);if(this.$(".client-list .lowlight").removeClass("lowlight"),t.hasClass("highlight"))t.removeClass("highlight"),t.addClass("lowlight"),this.display_client_details("hide",n),this.new_client=null,this.toggle_save_button();else{this.$(".client-list .highlight").removeClass("highlight"),t.addClass("highlight");var a=e.pageY-t.parent().offset().top;this.display_client_details("show",n,a),this.new_client=n,this.toggle_save_button()}},partner_icon_url:function(e){return"/web/image?model=res.partner&id="+e+"&field=image_128"},edit_client_details:function(e){this.display_client_details("edit",e)},undo_client_details:function(e){e.id?this.display_client_details("show",e):this.display_client_details("hide")},save_client_details:function(e){var t=this,i={};this.$(".client-details-contents .detail").each(function(e,n){if(n.name){if(t.integer_client_details.includes(n.name)){var a=parseInt(n.value,10);isNaN(a)?i[n.name]=!1:i[n.name]=a}else i[n.name]=n.value||!1}}),this.uploaded_picture&&(i.image_1920=this.uploaded_picture),i.id=e&&e.id||!1;var n=this.$(".client-details-contents");n.off("click",".btn.save"),this.chrome.blockUI(),r.query({model:"res.partner",method:"create_from_medical_ui",args:[i]}).then(function(e){t.saved_client_details(e),t.chrome.unblockUI()}).catch(function(i){i.event&&i.event.preventDefault(),t.chrome.unblockUI();var a=d("Your Internet connection is probably down.");if(i.message.data){var r=i.message.data;a=r.arguments&&r.arguments[0]||r.message||a}t.gui.show_popup("error",{title:d("Error: Could not Save Changes"),body:a}),n.on("click",".btn.save",function(){t.save_client_details(e)})})},saved_client_details:function(e){var t=this;if(!_.isEmpty(e)){var i=e.id;t.medical.db.add_partners([e]);var n=t.medical.db.get_partner_by_id(i);if(n){t.new_client=n,t.toggle_save_button(),t.display_client_details("show",n);return}}t.display_client_details("hide",n)},resize_image_to_dataurl:function(e,t,i,n){e.onload=function(){var a=document.createElement("canvas"),r=a.getContext("2d"),s=1;e.width>t&&(s=t/e.width),e.height*s>i&&(s=i/e.height);var o=Math.floor(e.width*s),c=Math.floor(e.height*s);a.width=o,a.height=c,r.drawImage(e,0,0,o,c),n(a.toDataURL())}},load_image_file:function(e,t){var i=this;if(!e.type.match(/image.*/)){this.gui.show_popup("error",{title:d("Unsupported File Format"),body:d("Only web-compatible Image formats such as .png or .jpeg are supported")});return}s.getDataURLFromFile(e).then(function(e){var n=new Image;n.src=e,i.resize_image_to_dataurl(n,800,600,t)}).guardedCatch(function(){i.gui.show_popup("error",{title:d("Could Not Read Image"),body:d("The provided file could not be read due to an unknown error")})})},reload_partners:function(){var e=this;return this.medical.load_new_partners().then(function(){e.partner_cache=new p,e.render_list(e.medical.db.get_partners_sorted(1e3));var t=e.medical.get_order().get_client();t&&e.medical.get_order().set_client(e.medical.db.get_partner_by_id(t.id))})},display_client_details:function(e,t,i){var n=this,a=this.$(".searchbox input"),r=this.$(".client-details-contents"),s=this.$(".client-list").parent(),o=s.scrollTop(),c=r.height();if(r.off("click",".btn.edit"),r.off("click",".btn.save"),r.off("click",".btn.undo"),r.on("click",".btn.edit",function(){n.edit_client_details(t)}),r.on("click",".btn.save",function(){n.save_client_details(t)}),r.on("click",".btn.undo",function(){n.undo_client_details(t)}),this.editing_client=!1,this.uploaded_picture=null,"show"===e){r.empty(),r.append($(l.render("ClientDetails",{widget:this,partner:t}))),r.find(".client-view-tabs a").on("click",function(e){e.preventDefault(),$(this).tab("show")});var h=r.height();this.details_visible?s.scrollTop(s.scrollTop()-c+h):(s.height("-="+h),i<o+h+20?s.scrollTop(i-20):s.scrollTop(s.scrollTop()+h)),this.details_visible=!0,this.toggle_save_button()}else"edit"===e?(this.medical.config.iface_vkeyboard&&this.chrome.widget.keyboard&&(r.off("click",".detail"),a.off("click"),r.on("click",".detail",function(e){n.chrome.widget.keyboard.connect(e.target),n.chrome.widget.keyboard.show()}),a.on("click",function(){n.chrome.widget.keyboard.connect($(this))})),this.editing_client=!0,r.empty(),r.append($(l.render("ClientDetailsEdit",{widget:this,partner:t}))),this.toggle_save_button(),r.find("input").blur(function(){setTimeout(function(){n.$(".window").scrollTop(0)},0)}),r.find(".generate_file_no").click(function(e){if(!t.id){n.chrome.error_toast(d("Please create patient first, then try again."));return}n._rpc({model:"res.partner",method:"get_next_file_number",args:[[t.id],n.get_config_file_key()]}).then(function(e){e&&n.$(".client-"+n.get_config_file_key()).val(e)})}),r.find(".client-address-country").on("change",function(e){var t=r.find(".client-address-states"),i=this.value;t.empty(),t.append($("<option/>",{value:"",text:"None"})),n.medical.states.forEach(function(e){e.country_id[0]==i&&t.append($("<option/>",{value:e.id,text:e.name}))})}),r.find(".image-uploader").on("change",function(e){n.load_image_file(e.target.files[0],function(e){e&&(r.find(".client-picture img, .client-picture .fa").remove(),r.find(".client-picture").append("<img src='"+e+"'>"),r.find(".detail.picture").remove(),n.uploaded_picture=e)})})):"hide"===e&&(r.empty(),s.height("100%"),c>o?(r.css({height:c+"px"}),r.animate({height:0},400,function(){r.css({height:""})})):s.scrollTop(s.scrollTop()-c),this.details_visible=!1,this.toggle_save_button())},close:function(){this._super(),this.medical.config.iface_vkeyboard&&this.chrome.widget.keyboard&&this.chrome.widget.keyboard.hide()},onReadCard:function(e){console.log("Card Inserted..."),console.log(e),console.log(this),e&&this.renderData(e)},onRemoveCard:function(e){console.log("Card Removed..."),console.log(e),console.log(this)},onInvalidCard:function(){console.log("Invalid Card."),console.log(this)},renderData:function(e){if(e.civilId){var t=_.findWhere(this.medical.partners,{civil_code:e.civilId});if(t){var i=this.medical.db.get_partner_by_id(t&&t.id);this.medical.gui.show_popup("popup-civil-exist",{parent:this,partner:i,data:e})}else try{function n(e){return e?moment(e).format("YYYY-MM-DD"):""}var a=e.englishName.full,r=e.arabicName.full;$('input[name="name"]').val(a);var s=e.sex.isMale?"male":"female";$('select[name="gender"] option[value="'+s+'"').attr("selected","selected"),$('input[name="birthday"]').val(n(e.dateOfBirth.dateFormat)),$('input[name="ar_name"]').val(r),$('input[name="passport_no"]').val(e.registration.passport),$('input[name="civil_id_issued"]').val(n(e.registration.issued.dateFormat)),$('input[name="civil_id_expiry"]').val(n(e.registration.expires.dateFormat)),e.registration.residence.professionAr||e.registration.residence.profession?$('input[name="residence"]').val(e.registration.residence.articleNumber+" - "+(e.registration.residence.professionAr||e.registration.residence.profession)):e.registration.residence.articleTextAr||e.registration.residence.articleText?$('input[name="residence"]').val(e.registration.residence.articleNumber+" - "+(e.registration.residence.articleTextAr||e.registration.residence.articleText)):$('input[name="residence"]').val(e.registration.residence.articleNumber);var o=e.nationality.iso2Letter,c=_.findWhere(this.medical.countries,{code:o})||{};console.log("_ iso2letter : ",c,o,e.nationality);var c=_.findWhere(this.medical.countries,{code:o})||{};$('select[name="country_id"] option[value="'+c.id+'"').attr("selected","selected");var l=e.address.area.kwMohCode;if(l){var d=_.findWhere(this.medical.all_areas,{code:l})||{};$('select[name="area_id"] option[value="'+d.id+'"').attr("selected","selected")}$('input[name="area"]').val(e.address.area.english||""),$('input[name="area_kw_moh_code"]').val(l||""),$('input[name="block"]').val(e.address.block),$('input[name="house"]').val(e.address.building),$('input[name="floor"]').val(e.address.floor),$('input[name="street"]').val(e.address.street),$('input[name="civil_paci_no"]').val(e.address.uniqueKey),$('input[name="apartment_no"]').val(e.address.unitNumber),$('input[name="blood_group"]').val(e.bloodType.full),$('input[name="civil_code"]').val(e.civilId),$('input[name="civil_sponsor"]').val(e.registration.residence.sponsor),$('input[name="unit_type"]').val(e.address.unitType),$('input[name="street2"]').val(e.address.oneLine.english),$('input[name="governorate"]').val(e.address.governorate.english),e.contacts.originalNumbers[0]&&$('input[name="phone"]').val(e.contacts.originalNumbers[0].internationalNumber),e.contacts.originalNumbers[1]&&$('input[name="mobile"]').val(e.contacts.originalNumbers[1].internationalNumber),e.contacts.originalNumbers[2]&&$('input[name="work_phone"]').val(e.contacts.originalNumbers[2].internationalNumber),$('input[name="email"]').val(e.contacts.email)}catch(h){console.error(h)}}}});o.define_screen({name:"patient_list",widget:u});var m=n.MenuButtonWidget.extend({template:"BtnPatientScreen",button_click:function(){this.gui.show_screen("patient_list")}});return n.define_menu_button({name:"btn_show_patient",widget:m},{after:"btn_show_calendar"}),u.include({save_client_details:function(e){var t={},i=this.label_list.partner_id;if(console.log("Fields __  _       _",t),this.$(".client-details-contents .detail").each(function(e,i){t[i.name]=i.value||!1}),this.$(".client-details-contents .confirm-detail").each(function(e,i){t[i.name]=i.value||!1}),!t.name){this.gui.show_popup("error",d("A "+i+" Name is Required"));return}if(console.log("___ Required :: Civil Code : ",this.medical.config.req_patient_civil," --- Phone : ",this.medical.config.req_patient_phone),this.medical.config.req_patient_civil&&!t.civil_code&&!t.passport_no){this.gui.show_popup("error",d("A "+i+" Civil ID / Passport Is Required"));return}if(t.civil_code&&12!=t.civil_code.length){this.gui.show_popup("error",d("Civil ID must have 12 charactors."));return}if(t.phone&&0>_.indexOf([8,11,12],t.phone.length)){this.gui.show_popup("error",d("Invalid Phone. Allowed length 8 or 11, (Received : "+t.phone.length+")"));return}if(t.mobile&&0>_.indexOf([8,11,12],t.mobile.length)){this.gui.show_popup("error",d("Invalid Mobile. Allowed length 8 or 11, (Received : "+t.mobile.length+")"));return}if("pcr"==this.medical.config.company_code){if(this.medical.config.req_patient_civil&&!t.confirm_civil_code){this.gui.show_popup("error",d("Confirm Civil ID is Required."));return}if(t.civil_code&&t.confirm_civil_code&&t.civil_code!=t.confirm_civil_code){this.gui.show_popup("error",d("Civil ID and Confirm Civil ID does not match."));return}if(this.medical.config.req_patient_phone&&!t.confirm_phone){this.gui.show_popup("error",d("Confirm Phone is Required."));return}if(t.phone&&t.confirm_phone&&t.phone!=t.confirm_phone){this.gui.show_popup("error",d("Phone and Confirm Phone does not match."));return}if(t.mobile&&!t.confirm_mobile){this.gui.show_popup("error",d("Confirm Mobile is Required."));return}if(t.mobile&&t.mobile!=t.confirm_mobile){this.gui.show_popup("error",d("Mobile and Confirm Mobile does not match."));return}}if(this.medical.config.req_patient_nationality&&!t.nationality_id){this.gui.show_popup("error",d("Nationality is Required."));return}delete t.confirm_civil_code,delete t.confirm_phone,delete t.confirm_mobile;var n=t.birthday&&moment(t.birthday)||!1;if(t.birthday&&n&&(!n.isValid()||!n.isBetween("1800-01-01",moment(),null,"[]"))){this.gui.show_popup("error",d("Invalid Date of birth."));return}if(this.medical.config.req_patient_phone&&!t.phone&&!t.mobile){this.gui.show_popup("error",d("A "+i+" Phone/Mobile is Required"));return}if(this.medical.config.req_patient_gender&&!t.gender){this.gui.show_popup("error",d("A "+i+" Gender is Required."));return}this._super.apply(this,arguments)},display_client_details:function(e,t,i){var n=this;this._super.apply(this,arguments);var a=this.$(".client-details-contents");if(a.off("click",".btn.cust-form-close"),a.on("click",".btn.cust-form-close",function(){n.display_client_details("hide")}),"edit"==e&&(this.medical.config.req_patient_civil&&a.find(".civil_code, .passport_no").siblings(".label").append(" *"),"pcr"==this.medical.config.company_code&&a.find(".nationality_id").siblings(".label").append(" *"),this.medical.config.req_patient_phone&&a.find(".client-phone").siblings(".label").append(" *"),this.$(".touch-scrollable .scrollable-y").addClass("full-height"),a.off("click",".v-change-parent"),a.on("click",".v-change-parent",function(){var e=function(e){var t="%"+e.term+"%";return n._rpc({model:"res.partner",method:"search_read",domain:["|","|","|",["name","ilike",t],["phone","ilike",t],["mobile","ilike",t],["civil_code","ilike",t],],fields:["name","parent_id","phone","mobile","email"]})},t=n._select2Wrapper(d("Select a customer"),!1,e,!1,["name","phone","mobile"]),i=a.find(".detail.parent_id");i.prop("disabled",!1),i.removeClass("oe_hidden"),i.select2(t)}),a.on("change","input.civil_code",function(){var e=$(this).val();if(e&&$.isNumeric(e)&&12==e.length){var t=e.substr(1,2),i=e.substr(3,2),n=e.substr(5,2),r=new Date().getUTCFullYear().toString(),s=parseInt(r[2]+r[3]),o="19"+t;parseInt(t)<s&&(o="20"+t);var c=o+"-"+i+"-"+n;a.find("input.client-birthday").val(c)}})),"show"==e){if(a.off("click",".btn.history"),a.off("click",".btn.aged-balance"),a.off("click",".btn.v-print-file"),a.off("click",".btn.new-appointment"),a.on("click",".btn.v-print-file",function(){var e="medical_report.report_patient_file/"+t.id;n.chrome.print_report(e,"qweb-pdf")}),a.on("click",".btn.history",function(){n.show_customer_history(t.id)}),a.on("click",".btn.aged-balance",function(){n.show_aging_balance(t.id)}),a.on("click",".btn.new-appointment",function(){n.patient_new_appointment(t)}),this.show_customer_orders(t),this.show_customer_documents(t),this.medical.config.enable_insurance&&this.show_customer_insurance(t),this.show_blocked_by_doctors(t),this.medical.config.enable_prepaid_card&&(this.fetch_prepaid_cards(t.id).then(function(e){t.prepaid_cards=e,n.render_prepaid_cards(t,e)}),a.off("click",".v-prepaid-card-create"),a.on("click",".v-prepaid-card-create",function(e){e.stopPropagation();var i=n.$(".v-card-no").val();if(!i){n.chrome.error_toast(d("Card No. is required..."));return}n.create_prepaid_card(t,i)})),this.medical.config.allow_package){var r={running:"Running",done:"Finished",cancel:"Cancelled",hold:"On Hold"};this.fetch_packages(t.id).then(function(e){var t=[];_.each(e,function(e){t.push([e.name,e.session_total,e.session_done,e.session_remaining,r[e.state],])}),n.$("table.package-table").DataTable({data:t,retrieve:!0,columns:[{title:"Service"},{title:"Total Session"},{title:"Consumed"},{title:"Remaining"},{title:"State"},]})})}this.fetch_advance_payments(t.id).then(function(e){t.adv_payments=e,n.render_advance_payments(t,e)}),a.off("click",".v-adv-payment-create"),a.on("click",".v-adv-payment-create",function(e){e.stopPropagation(),n.gui.show_popup("popup-register-payment",{order:!1,partner:t,partner_id:t.id,confirm:function(){n.fetch_advance_payments(t.id).then(function(e){t.adv_payments=e,n.render_advance_payments(t,e)})}})}),a.off("click",".print-adv-payment"),a.on("click",".print-adv-payment",function(e){e.stopPropagation();var t=Number($(e.currentTarget).data().payment);n.medical.chrome.print_report(n.report_tags.payment+"/"+t,"qweb-pdf")})}},create_prepaid_card:function(e,t){var i=this;console.info("___ Creating Prepaid Card : ",t,e),i._rpc({model:"partner.prepaid.card",method:"check_and_create_card",args:[e.id,t]}).then(function(t){if(t.error){i.chrome.error_toast(t.error);return}i.render_prepaid_cards(e,t)})},fetch_prepaid_card_details:function(e,t){var i=this;i._rpc({model:"partner.prepaid.card",method:"fetch_prepaid_card_details",args:[t]}).then(function(t){i.gui.show_popup("popup-prepaid-card-details",{prepaid_card:t,partner:e})})},fetch_packages:function(e){return this._rpc({model:"customer.package",method:"search_read",args:[[["partner_id","=",e]],["name","session_total","session_done","session_remaining","session_price","state"]]})},fetch_prepaid_cards:function(e){return this._rpc({model:"partner.prepaid.card",method:"search_read",args:[[["partner_id","=",e]],t]})},render_prepaid_cards:function(e,t){var i=this,n=this.$("#js_partner_prepaid_card"),a=$(l.render("PrepaidCards",{prepaid_cards:t,widget:this}));n.html(a),a.find(".v-card-details").click(function(t){var n=$(this).data();i.fetch_prepaid_card_details(e,Number(n.card))})},fetch_advance_payments:function(e){return this._rpc({model:"account.payment",method:"search_read",args:[[["partner_id","=",e],["prepaid_card_id","=",!1],],i]})},render_advance_payments:function(e,t){var i=this.$("#patient-adv-payment-table"),n=$(l.render("AdvPaymentsSection",{adv_payments:t,widget:this}));i.html(n)},show_customer_orders:function(e){var t=this,i=t.medical.config.enable_show_cust_order_lines;r.query({route:"/partner/events",params:{partner_id:e.id}}).then(function(e){t.dataSet=[];var n=[];_.each(e,function(e){var a=e.name,r=t.format_datetime(e.start_time,!0),s=[e.id,a,r,e.resource_id,e.clinic_name,e.invoice.name||"",e.invoice.amount_total||"",e.invoice.amount_residual||"",t.medical.chrome.state_display[e.state]||d("Unknown"),];t.dataSet.push(s),i&&_.each(e.lines,function(t){n.push([e.id,a,r,t.employee,t.product_id,t.qty,t.price_unit,t.discount,t.price_subtotal_incl,])})});var a=t.$("table.order-table").DataTable({data:t.dataSet,retrieve:!0,columns:[{title:"Title"},{title:"Name"},{title:"Date/Time"},{title:"Resource"},{title:"Clinic"},{title:"Invoice"},{title:"Total"},{title:"Due"},{title:"State"},],columnDefs:[{visible:!1,targets:0,searchable:!1},{targets:[-2,-3],className:"text-right"},]});if($("table.order-table tbody").on("click","tr",function(){$(this).hasClass("selected")?$(this).removeClass("selected"):(a.$("tr.selected").removeClass("selected"),$(this).addClass("selected"),r.query({route:"/event",params:{order_id:a.row(this).data()[0]}}).then(function(e){t.medical.gui.show_popup("popup-appointment-details",{order:e,title:e.name,widget:t})}))}),i){var s=t.$("table.orderlines-table").DataTable({data:n,columns:[{title:"Title"},{title:"Ref"},{title:"Date/Time"},{title:"Employee"},{title:"Product / Service"},{title:"Qty"},{title:"Unit Price"},{title:"Discount"},{title:"Subtotal"},],columnDefs:[{visible:!1,targets:0,searchable:!1},]});$("table.orderlines-table tbody").on("click","tr",function(){$(this).hasClass("selected")?$(this).removeClass("selected"):(s.$("tr.selected").removeClass("selected"),$(this).addClass("selected"),r.query({route:"/event",params:{order_id:s.row(this).data()[0]}}).then(function(e){t.medical.gui.show_popup("popup-appointment-details",{order:e,title:e.name,widget:t})}))})}})},show_customer_documents:function(e){var t=this;$("span.btn-upload").on("click",function(i){var n=$("input[name='ufile']"),a=parseInt($("select[name='attachment_type']").val()),s=n.prop("files");if(s&&s.length>0){var o=s[0],c=new FileReader;c.onload=function(t){var i=t.target.result.split(",")[1];r.query({model:"res.partner",method:"upload_attachment",args:[{partner_id:e.id,attachment_type:a,name:o.name,data:i}]}).then(function(e){e=e[0];var t=$("table.document-table").DataTable();t.row.add([e.id,e.name,e.attachment_type_id&&e.attachment_type_id[1]||"",e.ir_attachment_id[0],e.ir_attachment_id[1]]),t.draw()})},c.onerror=function(e){t.gui.show_popup("error",{title:d("Could Not Read Image"),body:d("The provided file could not be read due to an unknown error")})},c.readAsDataURL(o)}}),r.query({route:"/partner/documents",params:{partner_id:e.id}}).then(function(e){t.dataSet=[],_.each(e,function(e){t.dataSet.push([e.id,e.name,e.attachment_type_id&&e.attachment_type_id[1]||"",e.ir_attachment_id[0],e.ir_attachment_id[1]])}),$("table.document-table").DataTable({data:t.dataSet,retrieve:!0,columns:[{title:"ID"},{title:"Name"},{title:"Type"},{title:"Attachment ID"},{title:"Document"},],columnDefs:[{render:function(e,t,i){return e+"&nbsp;&nbsp; <a href='/web/content/"+i[3]+"?download=true' title='Download'> <i class='fa fa-download'></i> </a> | <span class='remove-attachment' title='Remove' id="+i[0]+"> <i class='fa fa-trash'></i> </span>"},targets:4},{visible:!1,targets:0,searchable:!1},{visible:!1,targets:3,searchable:!1},]}),$("table.document-table tbody").on("click",".remove-attachment",function(e){r.query({model:"res.partner",method:"remove_attachment",args:[parseInt($(this).attr("id"))]}).then(function(t){if(t){var i=$(e.currentTarget).parents("tr"),n=i.parents("table").DataTable();n.row(i).remove(),n.draw()}})})})},_actionPatientInsurance:function(e){var t=this,i=$(e.currentTarget).attr("action"),n=$(e.currentTarget).attr("id");if("remove"==i)this._rpc({model:"insurance.card",method:"unlink",args:[[parseInt(n)]]}).then(function(e){e&&(t.medical.chrome.success_toast(d("Insurance Card is removed."),d("Successful")),t.show_customer_insurance(t.curr_partner))});else if("edit"==i||"add"==i){var a={ins_company:this.insuranceCompany,ins_pricelist:this.pricelist,insurances:this.insurances,ins_action:i,rec_id:parseInt(n),partner:this.curr_partner,confirm:function(e){t.show_customer_insurance(t.curr_partner)}};a.rec_id&&(a.card=_.findWhere(this.insurances,{id:a.rec_id})),this.gui.show_popup("popup-create-insurance",a)}},show_customer_insurance:function(e){var t=this;this.curr_partner=e,$("#patient-insurance").on("click","[action]",this._actionPatientInsurance.bind(this)),r.query({route:"/get/patient_insurance_data",params:{partner_id:e.id}}).then(function(e){t.insuranceDataSet=[],t.insurances=e.insurance,t.insuranceCompany=e.insurance_company,t.pricelist=e.pricelist,_.each(e.insurance,function(e){var i=moment(e.issue_date).format(t.medical.chrome.date_format),n=moment(e.expiry_date).format(t.medical.chrome.date_format);t.insuranceDataSet.push([e.id,e.name,e.insurance_company_id&&e.insurance_company_id[1]||"",e.pricelist_id[1],i,n])}),$.fn.DataTable.isDataTable("table.insurance-table")&&$("table.insurance-table").DataTable().clear().destroy(),$("table.insurance-table").DataTable({data:t.insuranceDataSet,columns:[{title:"ID"},{title:"Name"},{title:"Insu. Co."},{title:"Price List"},{title:"Issue Date"},{title:"Expiry Date"},],columnDefs:[{render:function(e,t,i){return e+"&nbsp;&nbsp; <span class='remove-edit' action='edit' title='Edit' id="+i[0]+"><i class='fa fa-edit'></i></span> <span class='remove-insurance' action='remove' title='Remove' id="+i[0]+"><i class='fa fa-trash'></i></span>"},targets:5},{visible:!1,targets:0,searchable:!1},]})})},show_customer_history:function(e){var t=this;r.query({route:"/partner/events",params:{partner_id:e}}).then(function(e){e&&e.length&&t.medical.gui.show_popup("partner-appointments",{events_data:e})})},show_aging_balance:function(e){this.medical.open_aging_popup(e)},patient_new_appointment:function(e){this.medical.from_partner_screen=!0,this.gui.show_screen("calendar",{partner:e})},show_blocked_by_doctors:function(e){var t=this,i=[];_.each(e.blocked_doctor_ids,function(e){var n=t.medical.resource_by_id[e];i.push([n.id,n.name])}),$.fn.DataTable.isDataTable("table.insurance-table")&&$("table.blocked-by-doctors-table").DataTable().clear().destroy(),$("table.blocked-by-doctors-table").DataTable({data:i,columns:[{title:"ID"},{title:"Name"},],columnDefs:[{visible:!1,targets:0,searchable:!1},]})}}),u});