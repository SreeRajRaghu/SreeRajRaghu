odoo.define("medical_js.invoice",function(require){"use strict";var i=require("medical_js.BaseWidget"),
    t=require("web.core");require("web.rpc");var n=require("web.utils"),
    r=require("web.session");require("web.field_utils"),
    i.Chrome;var o=i.gui,c=i.screens,a=t.qweb,s=t._t,d=n.round_decimals,u=i.PopupWidget.extend({template:"InvoiceRefundPopupWidget",events:_.extend({},i.PopupWidget.prototype.events,{"change input.v-line-refund":"compute_tot_refund","click .v-payment-register":"register_refund_invoice","click .v-payment-reset":"render_reset_payment","click .cancel":"click_cancel"}),show:function(){this._super.apply(this,arguments),this.refund_lines=this.options.refund_lines,this.invoice_widget=this.options.invoice_widget,this.invoice_data=this.invoice_widget.invoice_data},render_reset_payment:function(e){this.$(".v-cash-register").val(""),this.$(".v-cash-register:first").focus()},compute_tot_refund:function(){var e=this.compute_refund_lines().to_pay;this.$(".v-tot-refund").html(this.format_currency(e))},compute_refund_lines:function(){var e=this,i=0,t=0,n=[];return _.each(this.$(".v-line-refund"),function(r){var o=$(r).data(),c=o.line_id,a=Number(o.paid),d=Number(r.value||0);if(t+=a,a<d)return e.chrome.warning_toast(s("Refund amount could not be more than paid amount.")),{to_pay:0,max_pay:0};var u=_.findWhere(e.refund_lines,{aml_id:c});u&&(u.refund=d,n.push(u),i+=d)}),this.refund_lines=n,console.log("___ tot, max, refund_lines : ",i,t,n),{to_pay:i,max_pay:t}},register_refund_invoice:function(){var e=this,i=this.invoice_widget.order||{},t=this.invoice_widget.invoice||{},n=[],r=this.medical.config.current_session_id&&this.medical.config.current_session_id.length&&this.medical.config.current_session_id[0],o=0;if(!e.invoice_data.id){console.error("___ InvoiceId Not Found: self.invoice_data : ",e.invoice_data,t,i),e.chrome.warning_toast(s("Invoice not linked."));return}if(_.each(this.$el.find("input.v-cash-register"),function(c){var a=parseFloat(c.value),d=parseInt(c.name);a&&(o+=a,n.push({amount:a,journal_id:d,communication:i.name||i.ref||s("Appointment Payment"),partner_id:t.partner.id,medical_order_id:i.id,session_id:r,branch_id:e.medical.get_clinic().id}))}),0==n.length){e.chrome.warning_toast(s("Please add payment line."));return}var c=this.compute_refund_lines(),a=c.to_pay,u=c.max_pay;if(console.log("___ result, tot_amount : ",c,o),d(a,3)!=d(o,3)){e.chrome.warning_toast(s("Payment could be exact same as entered in the line."));return}if(d(a,3)>d(u,3)){e.chrome.warning_toast(s("Payment could be more than paid amount."));return}var h={default_med_employee_id:e.medical.get_cashier().id,default_branch_id:e.medical.get_clinic().id},l=this.refund_lines,p=[[e.invoice_data.id],l,n];console.info("___ register_refund_invoice : ",p),this.chrome.blockUI(),this._rpc({model:"account.move",method:"register_refund_invoice",args:p,context:h}).then(function(i){e.chrome.success_toast(s("Refund Registered Successfully.")),e.gui.close_popup(),e.gui.current_screen.rerender_screen()})}});o.define_popup({name:"popup-refund",widget:u});var h=c.ScreenWidget.extend({template:"InvoiceScreenWidget",auto_back:!0,events:_.extend({},c.ScreenWidget.prototype.events,{"click .btn-app-print":"print_sel_report","change .pay-checkbox":"show_about_to_pay","change .pay-amount":"show_about_to_pay_amount","click .go_back":"go_back","click .a-consume-product":"consume_product","click .v-cancel":"cancelOrder","click .v-reset":"resetOrder","click .v-validate":"validateInvoice","click .payment-line-unreconcile":"_onRemoveMoveReconcile","click .payment-line-cancel":"onCancelPayment","click .outstanding_credit_assign":"_onOutstandingCreditAssign","click .v-fetch-uninvoiced":"fetch_uninvoiced_orders","click .v-refund-popup":"open_refund_popup","click .v-refund-print":"print_refund_invoice","click .back":function(){this.gui.back()},"click .v-payment-reset":function(e){this.render_reset_payment(e)},"click .v-payment-register":function(e){this.register_payment(e)}}),print_refund_invoice:function(e){var i=$(e.currentTarget).data(),t=this.invoice_report+"/"+i.invoice;this.medical.chrome.print_report(t,"qweb-pdf")},prepare_inv_inputs:function(){return{}},open_refund_popup:function(){var e=this.get_refund_lines();e.length&&this.gui.show_popup("popup-refund",{refund_lines:e,invoice_widget:this})},validateInvoice:function(){var e=this,i=this.order&&this.order.id;if(!i){this.chrome.error_toast(_("Please re-open the Invoice."),_("Appointment doesn't found"));return}this.chrome.info_toast(s("Validating Invoice...")),this.blockUI();var t=this.prepare_inv_inputs();this._rpc({model:"medical.order",method:"action_validate_wrapper",args:[i,t]}).then(function(i){e.invoice=i,e.invoice_data=e.invoice.invoice_data,e.invoice_state=e.invoice_data&&e.invoice_data.state||"draft",e.chrome.unblockUI(),e.renderElement()}).guardedCatch(function(i){console.error("_ error : ",i),e.chrome.unblockUI()})},go_back:function(){this.gui.show_screen("calendar")},fetch_uninvoiced_orders:function(){var e=this;e.medical.config.suggest_uninvoiced_orders&&"draft"==e.invoice_state&&this._rpc({model:"medical.order",method:"get_uninvoiced_orders",args:[e.invoice.partner.id,[e.invoice.medical_order_id]]}).then(function(i){e.render_uninvoiced_orders(i)})},render_uninvoiced_orders:function(e){var i=this,t=this.$("#js_uninvoiced_order_suggestion");t.html(""),t.html(a.render("PendinInvoiceSuggestion",{uninvoiced_orders:e,widget:i})),t.find(".v-add-uninvoiced-order").click(function(e){e.stopPropagation();var t=parseInt($(this).data("order"));i.add_uninvoiced_order(t)})},add_uninvoiced_order:function(e){var i=this;console.info("___ add_uninvoiced_order : ",i.invoice_data.id,e),this.blockUI(),this._rpc({model:"account.move",method:"add_uninvoiced_order",args:[i.invoice_data.id,e]}).then(function(e){i.invoice=e,i.invoice_data=i.invoice.invoice_data,i.invoice_state=i.invoice_data&&i.invoice_data.state||"draft",i.chrome.unblockUI(),i.renderElement(),i.fetch_uninvoiced_orders(),i.chrome.info_toast(s("Appointment added Successfully."))}).guardedCatch(function(e){console.error("_ error : ",e),i.chrome.unblockUI()})},show_about_to_pay_amount:function(e){e.stopPropagation();var i=$(e.currentTarget),t=Number(i.val()),n=this.get_line_due(i.prev(".pay-checkbox"));if(t>n){this.chrome.error_toast(_("Amount cannot be more than due."),_("Invalid")),i.val(n);return}this.update_to_pay()},show_about_to_pay:function(e){e.stopPropagation();var i=$(e.currentTarget),t=this.get_line_due(i);i.next(".pay-amount").val(t),this.update_to_pay()},get_line_due:function(e){var i=e.prop("checked"),t=e.data("line_id");if(i){var n=_.findWhere(this.invoice.order_lines,{id:t});return d(n.price_subtotal-n.amount_paid,3)}return 0},update_to_pay:function(e){var i=this,t=0,n=0;return _.each(this.$(".pay-checkbox"),function(e){var r=$(e),o=r.prop("checked"),c=r.data("line_id");if(o){var a=_.findWhere(i.invoice.order_lines,{id:c});t+=Number(r.next(".pay-amount").val()),n+=a.price_subtotal-a.amount_paid}}),t=d(t,3),n=d(n,3),e||(this.$(".v-to-pay-amount").text(t),this.$(".v-to-pay").text(n)),this.invoice_pay_amount=t,this.invoice_tot_to_pay=n,[t,n]},show:function(){this._super(),this.invoice=this.gui.get_current_screen_param("invoice"),this.invoice_data=this.invoice.invoice_data,this.invoice_state=this.invoice_data&&this.invoice_data.state||"draft",this.order=this.gui.get_current_screen_param("order"),this.to_pay=0,this.renderElement(),this.$(".pay-checkbox").prop("checked","checked").trigger("change")},show_popup_consumable:function(e){var i=this,t=$(e.currentTarget),n="paid"==i.invoice_data.invoice_payment_state,r=t.data("mol_id");this.invoice&&!this.invoice.consu_picking_id&&(n=!1);var o={title:s("Consumable Products"),medical_order_line_id:r,consumable_products:[],is_paid:n,confirm:function(e){t.find(".count").text((e||[]).length)}};n?i.gui.show_popup("popup-product-consumable",o):this._rpc({route:"/medical/consumables",params:{medical_line_id:r}}).then(function(e){return _.extend(o,{consumable_products:e}),i.gui.show_popup("popup-product-consumable",o)})},renderElement:function(){var e=this;this._super.apply(this,arguments),this.$("input.tick_all_pays").click(function(i){e.$(".pay-checkbox").prop("checked",this.checked).trigger("change"),e.update_to_pay()});var i=this.$(".v-line-consumable");console.log("$consum_lines.length : ",i.length),i.length&&i.click(function(i){e.show_popup_consumable(i)})},consume_product:function(){var e=this,i=this.order&&this.order.id;this._rpc({model:"medical.order",method:"create_consumable_picking",args:[[i]]}).then(function(i){i?e.chrome.success_toast(_("Product(s) Consumed Successfully."),_("Successful")):e.chrome.error_toast(_("You can consume product(s) only once."),_("Error"))})},rerender_screen:function(){var e=this,i=this.order;this._rpc({route:"/event/invoice",params:{order_id:i.id}}).then(function(t){t&&!t.partner&&t.partner_id&&t.partner_id.length>1&&(t.partner=e.medical.db.get_partner_by_id(t.partner_id[0])),e.gui.show_screen("page_invoice",{"prev-screen":"calendar",invoice:t,order:i}),e.chrome.unblockUI()}).guardedCatch(function(i){console.error("_ error : ",i),e.chrome.unblockUI()})},cancelOrder:function(){var e=this,i=this.medical.get_order(),t=this.order&&this.order.id||this.options&&this.options.order_id||i.server_id;if(!t){this.chrome.error_toast(_("Please re-open the Invoice."),_("Appointment doesn't found"));return}confirm("Once you cancel the Invoice, Whole Appointment will be Cancelled. Do you want to proceed ?")&&(e.chrome.info_toast(s("Cancelling Appointment...")),this.blockUI(),this._rpc({model:"medical.order",method:"action_cancel_wrapper",args:[t]}).then(function(i){console.log("___ cancelOrder : ",i),e.chrome.unblockUI(),e.is_readonly=i.is_readonly,e.invoice_number=i.invoice_number,e.invoice_state="cancel",e.chrome.info_toast(s("Appointment Cancelled Successfully.")),e.gui.show_screen("calendar")}).guardedCatch(function(i){console.error("_ error : ",i),e.chrome.unblockUI()}))},resetOrder:function(){var e=this,i=this.medical.get_order(),t=this.order&&this.order.id||this.options&&this.options.order_id||i.server_id;if(!t){this.chrome.error_toast(_("Save the Appointment First"));return}return e.chrome.info_toast(s("Updating Server...")),this.blockUI(),r.rpc("/event/reset",{order_id:t}).then(function(i){if(e.chrome.unblockUI(),e.chrome.success_toast(s("Appointment settled to draft.")),console.log("___ Reset Order - Opening Appointment : ",i),!_.isEmpty(i)){var t=e.medical.toPosOrder(i);e.medical.set_order(t),e.gui.show_screen("appointment")}}).guardedCatch(function(i){console.error("_ error : ",i),e.chrome.unblockUI()})},validate_with_manager_user:function(){return this.gui.select_employee({security:!0,current_employee:this.medical.get_cashier(),title:s("Need Manager Password"),only_managers:!1})},print_sel_report:function(e){var i=this.$(".v-report-selection").val(),t=this.invoice&&this.invoice_data&&this.invoice_data||{};if(!this.order.patient_invoice_id){var n=t.id;this.order.patient_invoice_id=n}if(!this.order.insurance_invoice_id){var n=t.ref_invoice_id&&t.ref_invoice_id[0];this.order.insurance_invoice_id=n}this.print_selected_report(i,this.order)},render_reset_payment:function(e){this.$el.find(".v-payment-method input").val(""),this.$el.find(".v-payment-method input:first").focus()},get_refund_lines:function(){var e=this.$el.find(".refund-checkbox:checked");if(0==e.length)return this.chrome.warning_toast(s("Please select any line to refund.")),[];for(var i=[],t=0;t<e.length;t++){var n=$(e[t]).data();i.push({product:this.medical.db.get_product_by_id(Number(n.product)),paid:Number(n.paid)-Number(n.refund||0),product_id:n.product,aml_id:Number(n.line_id),refunded_amount:Number(n.refund),paid_amount:Number(n.paid)})}return i},get_selected_lines:function(){var e=this.$el.find(".pay-checkbox:checked");if(0==e.length)return this.chrome.warning_toast(s("Please select any service line.")),[];for(var i={},t=0;t<e.length;t++){var n=$(e[t]),r=n.data("pricelist"),o=Number(n.next(".pay-amount").val());if(this.get_line_due(n)-o>0&&r)return this.chrome.warning_toast(s("Partial payment not allowed for Insurance Line.")),{};i[parseInt(n.data("line_id"))]=o}return i},register_payment:function(){var e=this,i=this.order,t=this.invoice,n=[];if("posted"!=this.invoice_state){console.log("_ this.invoice_state : ",this.invoice_state,i,t),e.chrome.warning_toast(s("Invoice must be in 'posted' stage."));return}var r=this.get_selected_lines();if(_.isEmpty(r)){e.chrome.warning_toast(s("Select payable lines."));return}var o=0,c=e.medical.config.current_session_id&&e.medical.config.current_session_id.length&&e.medical.config.current_session_id[0],a=!1;if(_.each(this.$el.find("div.v-payment-line"),function(r){var d=$(r).find("input.v-cash-register"),u=parseFloat(d.val()),h=parseInt(d.attr("name"));if(u){o+=u;var l="";u&&$(r).find("input.v-cash-ref").length>0&&(l=$(r).find("input.v-cash-ref").val(),a=_.isEmpty(l)),n.push({amount:u,journal_id:h,communication:l||i.name||i.ref||s("Appointment Payment"),partner_id:t.partner.id,medical_order_id:i.id,session_id:c,branch_id:e.medical.get_clinic().id})}}),a){e.chrome.warning_toast(s("Reference number is required."));return}var u=this.update_to_pay(!0),h=u[0];if(u[1],d(h,3)!=d(o,3)){e.chrome.warning_toast(s("Payment could be exact same as entered in the line."));return}if(0==n.length){e.chrome.warning_toast(s("Please enter amount before registering payment."));return}var l={default_med_employee_id:e.medical.get_cashier().id,default_branch_id:e.medical.get_clinic().id};this.chrome.blockUI(),this._rpc({model:"medical.order",method:"register_payment_from_ui",args:[[i.id],n,"",r],context:l}).then(function(i){e.rerender_screen(),e.chrome.unblockUI(),e.chrome.success_toast(s("Payment added Successfully."))}).guardedCatch(function(i){console.error("_ error : ",i),e.chrome.unblockUI()})},get_outstanding_payment_line:function(e,i){return!!e&&!!i&&_.findWhere(e.content,{id:i})},_onOutstandingCreditAssign:function(e){e.stopPropagation(),e.preventDefault();var i=this,t=$(e.target).data("id")||!1,n=this.invoice&&this.invoice.outstanding,r=this.update_to_pay(!0),o=r[0];r[1];var c=this.get_outstanding_payment_line(n,t);if(0==o){this.chrome.error_toast(_("Please select the line to reconcile."));return}if(d(c.amount,3)<d(o,3)){this.chrome.error_toast(_("Payable amount should be less or equal then outstanding."));return}var a=this.get_selected_lines();if(_.isEmpty(a)){i.chrome.warning_toast(s("Select payable lines."));return}this.chrome.blockUI(),this._rpc({model:"account.move",method:"js_assign_outstanding_line_wrapper",args:[i.invoice_data.id,t,a]}).then(function(){i.rerender_screen(),i.chrome.unblockUI()}).guardedCatch(function(e){console.error("_ error : ",e),i.chrome.unblockUI()})},_onRemoveMoveReconcile:function(e){var i=this,t=$(e.target).closest("div.payment-line-unreconcile"),n=parseInt(t.data("pid"));void 0===n||isNaN(n)||(this.chrome.blockUI(),this._rpc({model:"account.move.line",method:"unreconcile_payment",args:[n],context:{move_id:this.res_id}}).then(function(){i.rerender_screen(),i.chrome.unblockUI()}).guardedCatch(function(e){console.error("_ error : ",e),i.chrome.unblockUI()}))},onCancelPayment:function(){var e=this,i=parseInt($(event.target).closest("div.payment-line-cancel").data("pid"));if(void 0!==i&&!isNaN(i))return e.validate_with_manager_user().then(function(t){e.chrome.blockUI(),e._rpc({model:"account.move.line",method:"cancel_payment",args:[i],context:{move_id:e.res_id}}).then(function(){e.rerender_screen(),e.chrome.unblockUI()}).guardedCatch(function(i){console.error("_ error : ",i),e.chrome.unblockUI()})})}});return o.define_screen({name:"page_invoice",widget:h}),h});