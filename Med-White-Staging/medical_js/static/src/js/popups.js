odoo.define("medical_js.popups",function(require){"use strict";require("web.framework");var t=require("medical_js.BaseWidget"),
    i=require("mail.Chatter"),
    s=require("web.data_manager"),
    a=require("web.Context"),
    n=require("web.utils"),
    o=require("web.core"),
    d=t.PopupWidget,c=t.gui,l=o.qweb,r=o._t;n.round_decimals;var p=d.extend({template:"NumberInputPopupWidget",click_confirm:function(){var e=Number(this.$("input").val());this.gui.close_popup(),this.options.confirm&&this.options.confirm.call(this,e)}});c.define_popup({name:"popup-number",widget:p});var h=d.extend({template:"DiscountPopupWidget",events:_.extend({},d.prototype.events,{'change input[name="disc_perc"]':"_onChangeDiscPerc",'change input[name="disc_fix"]':"_onChangeDiscFix"}),click_confirm:function(){var e=Number(this.$("input[name='disc_perc']").val()),t=Number(this.$('input[name="disc_fix"]').val()),i=!1;!this.options.show_reason||(i=Number(this.$("select option:selected").val()))||this.chrome.info_toast(r("Please select the Discount Reason")),this.gui.close_popup(),this.options.confirm&&this.options.confirm.call(this,e,t,i)},_onChangeDiscPerc:function(e){e.preventDefault(),$(this.$el.find("input[name='disc_fix']")).val("")},_onChangeDiscFix:function(e){e.preventDefault(),$(this.$el.find("input[name='disc_perc']")).val("")}});c.define_popup({name:"popup-discount",widget:h});var u=d.extend({template:"AnalyticAccountPopupWidget",show:function(){this._super.apply(this,arguments),this.$el.find("select").select2(),this.options.value&&this.$el.find("select").select2("val",this.options.value)},click_confirm:function(){var e=Number(this.$("select").val());this.gui.close_popup(),this.options.confirm&&this.options.confirm.call(this,e)}});c.define_popup({name:"popup-analytic-account",widget:u});var m=d.extend({template:"AnalyticAccountTagPopupWidget",show:function(){this._super.apply(this,arguments);var e=this.options.value||[],t=[];console.log("___ selected : ",e),_.each(this.medical.analytic_tags,function(i){var s={id:i.id,text:i.name};-1!=_.indexOf(e,i.id)&&(s.selected=!0),t.push(s)}),this.$el.find("input").select2({tags:!0,data:t,val:e})},click_confirm:function(){var e=this.$("input").select2("val")||[];this.gui.close_popup(),this.options.confirm&&this.options.confirm.call(this,_.map(e,Number))}});c.define_popup({name:"popup-analytic-tags",widget:m});var f=d.extend({template:"ProductConsumableWidget",events:_.extend({},d.prototype.events,{"click .edit":"_onEdit","click .remove":"_onRemove","click .save":"_onSave","click .discard":"_onDiscard"}),show:function(){this._super.apply(this,arguments),this.mo_line_id=this.options.medical_order_line_id&&parseInt(this.options.medical_order_line_id),this.existing_lines=this.options.lines,this.consumable_products=this.options&&this.options.consumable_products||[],this.is_paid=this.options&&this.options.is_paid,this.existing_ids=[],this.lines=[],this.current_line_idx=!1;var e=[];console.log("ProductConsumable : ",this.consumable_products),_.each(this.consumable_products,function(t){var i=t.name;t.qty_available&&t.uom&&(i+=" ("+t.qty_available+" "+t.uom+")"),e.push({id:t.id,text:i})}),this.$el.find(".product-select").select2({data:e}),this.fetch_lines(),this.no_change_if_paid()},no_change_if_paid:function(){this.is_paid?this.$(".div-crud, .confirm, .edit, .remove").hide():this.$(".div-crud").is(":visible")||this.$(".div-crud, .confirm, .edit, .remove").show()},click_confirm:function(){var e=this;this.$("input").select2("val");var t=[];_.each(e.lines,function(i){i.id?(t.push([1,i.id,{qty:i.qty,product_id:i.product_id}]),e.existing_ids.splice(e.existing_ids.indexOf(i.id),1)):t.push([0,0,{qty:i.qty,product_id:i.product_id}])}),_.each(e.existing_ids,function(e){t.push([2,e,!1])}),this._rpc({model:"medical.order.line",method:"update_consumables",args:[[e.mo_line_id],{consumable_ids:t}]}).then(function(t){e.gui.close_popup(),e.options.confirm&&e.options.confirm.call(e,t)})},fetch_lines:function(){var e=this;return this._rpc({model:"medical.order.line.consumable",method:"search_read",domain:[["medical_order_line_id","=",e.mo_line_id]],fields:["product_id","qty"]}).then(function(t){console.log("Lines : ",t),console.log("Product consumable : ",e.medical.db.product_consumables),_.each(t,function(t){e.existing_ids.push(t.id);var i=t.product_id;t.product_id=i[0],t.product_name=_.findWhere(e.medical.db.product_consumables,{id:i[0]}).display_name,e.lines.push(t)}),e.render_lines()})},render_lines:function(){var e=this.$(".table-consumable-lines tbody");e.empty();var t=l.render("RowConsumableLines",{lines:this.lines,widget:this});e.append(t)},_onEdit:function(e){var t=$(e.currentTarget).parents("tr").data("line_index"),i=this.lines[t];this.$el.find("input.product-select").select2("val",i.product_id),this.$el.find("input.qty").val(i.qty),this.current_line_idx=t},_onRemove:function(e){var t=$(e.currentTarget).parents("tr").data("line_index");this.lines.splice(t,1),this.render_lines(),this.clear_edit()},_onSave:function(e){var t=this,i=this.$el.find("input.product-select").val(),s=parseFloat(this.$el.find("input.qty").val());if(!i||!s||s<=0)return this.gui.show_popup("error",{title:"Invalid Data",body:"Please fill product and quantity greater than 0"});var a=_.filter(this.consumable_products,function(e){return e.id==i});a&&(a=a[0]);var n={product_id:a.id,product_name:a.display_name,qty:s};!1!==t.current_line_idx?t.lines[t.current_line_idx]=n:t.lines.push(n),t.render_lines(),t.clear_edit()},_onDiscard:function(e){this.clear_edit()},clear_edit:function(){this.$el.find("input.product-select").select2("val",""),this.$el.find("input.qty").val(""),this.current_line_idx=!1}});c.define_popup({name:"popup-product-consumable",widget:f});var v=d.extend({template:"EmployeePopupWidget",show:function(){this._super.apply(this,arguments),this.$el.find("select").select2(),this.options.value&&this.$el.find("select").select2("val",this.options.value)},click_confirm:function(){var e=Number(this.$("select").val());this.gui.close_popup(),this.options.confirm&&this.options.confirm.call(this,e)}});c.define_popup({name:"popup-select-employee",widget:v});var g=d.extend({template:"PopupMailChatter",events:_.extend({},d.prototype.events,{"click .cancel":"click_cancel"}),click_cancel:function(){this.gui.close_popup()},show:function(){this._super.apply(this,arguments),this.order=this.options.order,this.add_chatter()},add_chatter:function(){var e=this;this._rpc({model:"medical.order",method:"search_read",domain:[["id","=",e.order.id]],fields:["message_follower_ids","message_ids"]}).then(function(t){var n=t[0];if(!n.message_follower_ids.length){e.$el.find(".v-no-history").show();return}s.load_action("medical_app.action_medical_order").then(function(t){var o={model:"medical.order",context:new a({}),views_descr:t.views};return s.load_views(o,{}).then(function(t){var s=t.form,a={data:{message_ids:{res_ids:n.message_ids},display_name:n.name},fields:s.fields,fieldsInfo:{form:s.fields},model:"medical.order",res_id:n.id,res_ids:[n.id],ref:n.id,type:"record",viewType:"form"};e.chatter=new i(e,a,{mail_thread:"message_ids"},{isEditable:!1,viewType:"form"}),e.chatter.appendTo(e.$el.find(".h-chatter")).then(function(){e.chatter.$el.unwrap()})})})})}});c.define_popup({name:"popup-mail-chatter",widget:g});var y=d.extend({template:"PartnerAppointments",events:_.extend({},d.prototype.events,{"click .cancel":"click_cancel"}),init:function(e,t){this._super(e,t),this.weekdays=moment.weekdays},show:function(e){var t=this;this._super(e),this.dataSet=[],this.events_data_by_key={};var i=moment().startOf("day"),s=0,a=0,n=0,o=t.medical.chrome.state_display;_.each(e.events_data,function(e){t.events_data_by_key[e.id]=e;var d=moment(t.toUserTZ(e.start_time)),c=d.clone().startOf("day").diff(i,"days"),l="!TODAY";c>0?(l="!FUTURE",n+=1):c<0?(l="!OLD",a+=1):s+=1,e=[e.id,l,e.name,d.format(t.date_format),t.weekdays(parseInt(d.format("e"))),d.format(t.time_format),o[e.state],e.resource_id,e.clinic_name,],t.dataSet.push(e)}),this.total_today=s,this.total_old=a,this.total_future=n;var d=this.$("table.appointment-table").DataTable({data:this.dataSet,columns:[{title:"ID"},{title:"Filter"},{title:"Ref"},{title:"Date"},{title:"Day"},{title:"Start"},{title:"State"},{title:"Resource"},{title:"Clinic"},],columnDefs:[{visible:!1,targets:0,searchable:!1},{visible:!1,targets:1},],dom:"Bfrtip",scrollX:!0,scrollY:"200px",scrollCollapse:!0,buttons:[{text:'<i class="fa text-dark"> Old <span class="badge badge-pill badge-secondary"> '+this.total_old+"</span></i>",action:function(e,t,i,s){t.data().search("!OLD").draw()}},{text:'<i class="fa text-dark"> Today <span class="badge badge-pill badge-secondary"> '+this.total_today+"</span></i>",action:function(e,t,i,s){t.data().search("!TODAY").draw()}},{text:'<i class="fa text-dark"> Future <span class="badge badge-pill badge-secondary"> '+this.total_future+"</span></i>",action:function(e,t,i,s){t.data().search("!FUTURE").draw()}},{text:'<i class="fa text-dark"> Waiting <span class="badge badge-pill badge-secondary"> 0</span></i>',action:function(e,t,i,s){t.data().search("!WAITING").draw()}},{text:'<i class="fa text-dark"> ALL <span class="badge badge-pill badge-secondary"> '+(this.total_future+this.total_today+this.total_old)+"</span></i>",action:function(e,t,i,s){t.data().search("").draw()}}]}),c=this.$("#appoitment-detail");c.hide(),this.$("table.appointment-table tbody").on("click","tr",function(){if($(this).hasClass("selected"))$(this).removeClass("selected"),c.hide();else{d.$("tr.selected").removeClass("selected"),$(this).addClass("selected");var e=d.row(this).data(),i=l.render("PartnerAppointmentsDetail",{event_data:t.events_data_by_key[e[0]],states:t.medical.chrome.state_display,widget:t});c.empty(),c.append(i),c.show()}})}});c.define_popup({name:"partner-appointments",widget:y});var b=d.extend({template:"PartnerAging",init:function(e,t){this._super(e,t),this.aging_data=!1},show:function(e){this._super(e),this.aging_data=e.aging_data},renderElement:function(){var e=this;this._super();var t=this.$(".aging-lines"),i=this.$("h3.line-title");t.hide(),i.hide(),this.$("span.aging").on("click",function(s){var a=$(s.currentTarget).data("value"),n=e.$(".aging-lines tbody");t.show(),i.show(),n.empty(),i.text({0:"+120 Days",1:"90 - 120 Days",2:"60 - 90 Days",3:"30 - 60 Days",4:"0 - 30 Days",5:"Not Due"}[a]);var o=e.aging_data[a]&&e.aging_data[a].lines||!1;if(o&&o.length>0){var d=l.render("AgingLine",{lines:o,widget:e});n.append(d)}else n.append("<tr><td colspan='3'> No Records </td></tr>")})}});c.define_popup({name:"partner-aging",widget:b});var w=d.extend({template:"AskActionNotePopup",init:function(e,t){this._super(e,t),this.mode=!1,this.note="",this.last_action_id=!1},show:function(e){this.mode=e.mode,this.note=e.note,this.last_action_id=e.last_action_id,this._super(e)}});c.define_popup({name:"ask-action-note",widget:w});var x=d.extend({template:"ComplainPopup",click_confirm:function(){var e={};_.each(this.$el.find("textarea, select, input"),function(t){var i=$(t);e[i.attr("name")]=i.val(),"checkbox"==i.prop("type")&&(e[i.attr("name")]=i.prop("checked"))}),this.options.confirm&&(e.old_data=this.options.complain,this.options.confirm.call(this,e))}});c.define_popup({name:"complain-popup",widget:x})});