odoo.define("medical_js.multi_appointments",function(require){"use strict";var t=require("medical_js.appointment"),
    i=require("medical_js.BaseWidget"),
    r=require("medical_js.calendar"),
    s=require("medical_js.models"),
    a=require("web.core");i.screens,a.qweb,a._t,r.include({parseRecordsToEvents:function(e){var t=this,i=this._super.apply(this,arguments);if(this.medical.config.allow_multi_appointments)for(var r=[],s=0;s<i.length;s++){var a=i[s],d=a&&a.record;if(d&&d.is_multi_order&&d.order_lines){a.resourceId;var l=[];_.each(d.order_lines,function(e){if(e.multi_resource_id&&e.multi_resource_id.length){var i=e.multi_resource_id[0],s=e.multi_start_time&&t.toUserTZ(new Date(e.multi_start_time))||a.start,o=moment(s).add(e.duration,"hours"),u=_.extend({},_.clone(a),{resourceId:i,start:s,end:o._d});u.record=_.clone(d),u.record.order_lines=[e],u.record.resource_id=e.multi_resource_id,u.line_id=e.id,r.push(u)}else l.push(e)}),l.length&&(d.order_lines=l,r.push(a))}else r.push(a)}else r=i;return r}});var d=s.Orderline;s.Orderline=s.Orderline.extend({set_multi_data:function(e,t){this.multi_resource_id=e,this.multi_start_time=t,this.trigger("change",this)},get_multi_data:function(){var e=this.multi_resource_id,t=this.multi_start_time;return e||(e=this.order.resource_id),t||(t=this.order.user_start_time),{multi_resource_id:e,multi_start_time:t}},get_multi_data_display:function(){var e,t=this.get_multi_data(),i="";if(t.multi_resource_id){i+='<span class="fa fa-user-md" />',i+=this.medical.resource_by_id[t.multi_resource_id].name,i+=' @ <span class="fa fa-clock" />'}return i+this.medical.chrome.format_datetime(t.multi_start_time)},update_db_line_data:function(e,t,i){if(d.prototype.update_db_line_data.apply(this,arguments),t.multi_resource_id&&t.multi_resource_id.length){var r=t.multi_start_time;r&&(r=moment(this.medical.chrome.toUserTZ(t.multi_start_time,!0))),this.set_multi_data(t.multi_resource_id[0],r)}},export_as_JSON:function(){var e=d.prototype.export_as_JSON.apply(this,arguments),t=this.get_multi_data();return e.multi_resource_id=t.multi_resource_id,t.multi_start_time&&(e.multi_start_time=this.medical.chrome.format_server_datetime(this.medical.chrome.getUTC(t.multi_start_time._d))||!1),e}}),t.OrderWidget.include({render_orderline:function(e){var t=this,i=this._super.apply(this,arguments),r=i.querySelector(".v-line-multi");return r&&r.addEventListener("click",function(i){var r=e.get_multi_data(),s=e.order.get_clinic(),a=t.medical.db.clinic_by_id[s].resources;t.gui.show_popup("popup-multi-appointment",{start_time:r.multi_start_time,resource_id:r.multi_resource_id,orderline:e,resource_list:a})}),i}});var l=i.PopupWidget.extend({template:"MultiAppointmentPopupWidget",show:function(){this._super.apply(this,arguments),this.$("[name='resource_id']").select2(),this.options.resource_id&&this.$("[name='resource_id']").select2("val",this.options.resource_id),this.$("[name='start_time']").val(this.medical.chrome.format_datetime(this.options.start_time))},click_confirm:function(){var e=parseInt(this.$("[name='resource_id']").val()),t=this.$("[name='start_time']").val();if(!(t=moment(t,this.medical.chrome.datetime_format))||!e||"Invalid Date"==t){this.medical.chrome.error_toast("Inputs are required.","Invalid");return}this.options.orderline.set_multi_data(e,t);var i=_.findWhere(this.medical.db.all_resources,{id:e});i&&i.hr_staff_id&&i.hr_staff_id.length&&this.options.orderline.set_line_employee_id(i.hr_staff_id[0]),this._super.apply(this,arguments)}});i.gui.define_popup({name:"popup-multi-appointment",widget:l})});