odoo.define("medical_js.waiting_list",function(require){"use strict";var e=require("medical_js.BaseWidget"),
    i=require("web.core"),
    a=require("web.utils"),
    n=e.PopupWidget,r=e.screens,s=e.Chrome,d=e.gui,c=i.qweb,o=i._t;a.round_precision;var l=n.extend({template:"WaitingAddCallNotePopup",renderElement:function(){this._super();var t=this.options&&this.options.line;t&&(this.$("input[name='id']").val(t.id),this.$("textarea[name='after_call_note']").val(t.after_call_note||""))},click_confirm:function(){var t=this,e=parseInt(this.$("input[name='id']").val()),i=this.$("textarea[name='after_call_note']").val();this._rpc({model:"app.waiting.list",method:"write",args:[[e],{after_call_note:i}]}).then(function(a){var n=[];return _.each(t.medical.waiting_list,function(t){parseInt(t.id)==e&&(t.after_call_note=i),n.push(t)}),t.medical.waiting_list=n,t.gui.close_popup(),t.chrome.success_toast("After Call Note Added Successfully."),t.gui.current_screen.show(!0),a})}});d.define_popup({name:"waiting-add-after-call-note",widget:l});var p=n.extend({template:"WaitingAddPopup",renderElement:function(){var t=this;this._super();var e=this.options&&this.options.order;t.medical.db.partner_by_id,t.medical.resource_by_id;var i=this.options&&this.options.disabled_fields;_.isObject(e)&&_.each(_.keys(e),function(a){t.$("[name='"+a+"']").val(e[a]||""),_.contains(i,a)&&t.$("[name='"+a+"']").attr("disabled","disabled")}),t.$el.find("select[name='resource_id']").select2({placeholder:"Select Resource"}),t.$el.find("select[name='partner_id']").select2({placeholder:"Select Room"});var a=t.$el.find("select[name='service_ids']"),n=[];a.select2(),e&&e.service_ids&&(_.each(e.service_ids,function(e){n.push({id:e,text:(t.medical.db.get_product_by_id(e)||{}).display_name})}),a.select2("data",n)),a.on("change",function(t){var e=[],i=!1,a=!1,n=$(t.currentTarget).find("option"),r=$(t.currentTarget).find("option:selected");n.length==r.length&&(a=!0),_.each(n,function(t){var a=$(t);a.prop("selected")&&"all"==a.prop("value")?i=!0:e.push(a.val())}),i&&$(t.currentTarget).select2("val",e),i&&a&&$(t.currentTarget).select2("val","")}),e&&e.service_ids&&(n=[],_.each(a.find("option"),function(t){_.contains(e.service_ids,$(t).data("id"))&&n.push($(t).val())}),a.select2("val",n||""))},click_confirm:function(){var t,e=this,i={},a=this.$("input[name='id']"),n=this.$("input[name='medical_order_id']"),r=this.$("input[name='date']"),s=this.$("select[name='resource_id']"),d=this.$("select[name='partner_id']"),c=(this.$("input[name='patient_mobile']"),this.$("select[name='service_ids']")),l=this.$("textarea[name='note']"),p=!1;_.each([r],function(t){var e=t.parents("tr").children("th");e.children("span").remove(),i[t.attr("name")]=t.val()||"",t.val()||t.attr("disabled")||(e.append("<span class='text-danger'> * </span>"),p=!0)}),_.each([s],function(t){var e=t.parents("tr").children("th");e.children("span").remove(),i[t.attr("name")]=t.find("option:selected").data("id"),t.val()||(e.append("<span class='text-danger'> * </span>"),p=!0)}),_.each([c],function(t){var e=t.parents("tr").children("th");e.children("span").remove(),i[t.attr("name")]=t.find("option:selected").data("id"),t.select2("val").length||t.select2("data").length||(e.append("<span class='text-danger'> * </span>"),p=!0)});var h=[],u=[];if(_.each(c.find("option:selected"),function(t){h.push($(t).data("id"));var e=$(t).data("line-id");console.log("___ lid : ",e),e&&u.push()}),i.service_ids=h,i.medical_order_line_ids=u,p){this.chrome.error_toast("* Field values missing...!",o("Missing"));return}if(d.select2("data")){var g=$(d.select2("data").element[0]);i[d.attr("name")]=g.data("id");var m=g.data("id"),f=e.medical.db.get_partner_by_id(m);i.patient_mobile=f&&f.mobile||""}return a.val()&&(i[a.attr("name")]=parseInt(a.val())),n.val()&&(i.medical_order_id=parseInt(n.val())),l.val()&&(i[l.attr("name")]=l.val()),(t=this._rpc({model:"app.waiting.list",method:"create_update_waiting",args:[i]})).then(function(t){e.medical.waiting_list=t,e.gui.close_popup(),e.gui.current_screen.show(!0),e.options&&e.options.confirm&&e.options.confirm.call(e)})}});d.define_popup({name:"waiting-add",widget:p});var h=r.ScreenWidget.extend({template:"WaitingListScreen",auto_back:!0,events:_.extend({},r.ScreenWidget.prototype.events,{"click .v-add-new":"edit_waiting","click .v-btn-edit":"edit_waiting","click .v-btn-cancel":"cancel_waiting","click .v-btn-call-note":"add_call_note","click .v-btn-restore":"restore_to_appointment","click .v-btn-new-appointment":"convert_to_appointment"}),show:function(){var t=this;this._super.apply(this,arguments),this.fetch_waiting_list().then(function(){t.renderDatatable()})},hide:function(){this._super.apply(this,arguments),this.$("table.v-data-table").dataTable({retrieve:!0,bDestroy:!0}).fnDestroy(),this.$("#WaitingListBody").html("")},fetch_waiting_list:function(){var t=this;return t._rpc({model:"app.waiting.list",method:"fetch_waiting_lines",args:[[]]}).then(function(e){return t.medical.waiting_list=e,e})},renderDatatable:function(){console.log("___ renderDatatable : ",this.medical.waiting_list),this.$("#WaitingListBody").html(""),$(c.render("WaitingListTBody",{widget:this})).appendTo(this.$("#WaitingListBody")),this.table_waiting=this.$("table.v-data-table").DataTable({retrieve:!0,columnDefs:[{targets:-1,data:this.medical.waiting_list},{targets:1,data:"todo_date"}]})},reloadTable:function(){this.table_waiting&&this.table_waiting.reload()},edit_waiting:function(t){t.stopPropagation();var e=$(t.currentTarget).parents("tr"),i=_.where(this.medical.waiting_list,{id:e.data().id});i=i&&i[0],this.medical.gui.show_popup("waiting-add",{order:i})},restore_to_appointment:function(t){var e=this;t.stopPropagation();var i=$(t.currentTarget).parents("tr").data().id,a=_.filter(e.medical.waiting_list,function(t){return t.id==i});if((a=a&&a[0])&&!a.medical_order_id){e.gui.show_popup("error",{title:o("No Appointment."),body:o("There is no appointment for this waiting")});return}this._rpc({model:"app.waiting.list",method:"restore_to_appointment",args:[[i]]}).then(function(t){if(!t.status){e.chrome.error_toast(t.message||"Cannot be restored");return}e.gui.show_screen("calendar"),e.chrome.success_toast("Appointment Restored Successfully.")})},convert_to_appointment:function(t){var e=this;t.stopPropagation();var i=$(t.currentTarget).parents("tr").data().id,a=_.findWhere(e.medical.waiting_list,{id:i}),n=e.medical.add_new_order();_.each(a.service_ids,function(t){var i=e.medical.db.get_product_by_id(t);n.add_product(i,{quantity:parseFloat(1),price:i.price_unit,discount:i.discount})});var r=e.medical.db.get_partner_by_id(a.partner_id[0]);n.set_client(r),n.set_resource_id(a.resource_id[0]),n.set_waiting_list(a.id),e.medical.waiting_to_appointment=!0,e.medical.set_order(n),console.log("___ order : ",n),e.medical.gui.show_screen("calendar")},cancel_waiting:function(t){var e=this;t.stopPropagation();var i=$(t.currentTarget).parents("tr").data().id;this._rpc({model:"app.waiting.list",method:"mark_as_canceled",args:[[i]]}).then(function(t){e.chrome.success_toast("Waiting List Updated Successfully."),e.show()})},add_call_note:function(t){t.stopPropagation();var e=$(t.currentTarget).parents("tr"),i=_.where(this.medical.waiting_list,{id:e.data().id});i=i&&i[0],this.medical.gui.show_popup("waiting-add-after-call-note",{line:i})}});d.define_screen({name:"waiting-list",widget:h});var u=e.StatusWidget.extend({template:"WaitingApp",start:function(){var t=this;this.$el.off("click"),this.$el.click(function(e){t.medical.gui.show_screen("waiting-list")})}});s.include({build_widgets:function(){this.widgets.push({name:"waiting_app",widget:u,append:".v-top-right"}),this.medical.waiting_list=[],this._super.apply(this,arguments)},update_waiting_count:function(t){$(".v-waiting-count").html(t)},fetch_waiting_count:function(){var t=[["date","=",moment().format(this.date_server_format)],["state","!=","done"]],e=this;this._rpc({model:"app.waiting.list",method:"search_count",args:[t]},{timeout:6e3,shadow:!0}).then(function(t){e.update_waiting_count(t)})},execute_auto_refresh_pool:function(){this._super(),this.fetch_waiting_count()}})});