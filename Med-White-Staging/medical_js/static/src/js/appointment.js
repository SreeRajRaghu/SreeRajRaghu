odoo.define("medical_js.appointment", function(require) {
    "use strict";
    var t = require("medical_js.BaseWidget");
    t.Chrome;
    var i = t.gui,
        r = require("web.core"),
        n = require("web.utils");
        require("web.session"),
        require("web.field_utils"),
        require("medical_js.models");
    var o=t.screens,a=r.qweb,c=r._t;n.round_precision;var s=[],d=function(e,b){b=b||{};var k,w=s,C=w.length;if(b.after)for(k=0;k<w.length;k++)w[k].name===b.after&&(C=k+1);else if(b.before){for(k=0;k<w.length;k++)if(w[k].name===b.after){C=k;break}}w.splice(k,0,e)},l=t.MedicalBaseWidget.extend({template:"ActionButtonWidget",label:c("Button"),renderElement:function(){var e=this;this._super(),this.$el.click(function(){e.button_click()})},button_click:function(){this.$el.addClass("active").siblings().removeClass("active")},highlight:function(e){this.$el.toggleClass("highlight",!!e)},altlight:function(e){this.$el.toggleClass("altlight",!!e)}}),p=t.MedicalBaseWidget.extend({template:"OrderWidget",init:function(e,b){var k=this;this._super(e,b),this.medical.bind("change:selectedOrder",this.change_selected_order,this),this.line_click_handler=function(e){k.click_line(this.orderline,e)},this.minus_qty_handler=function(e){k.click_change_qty(this.orderline,-1,e)},this.plus_qty_handler=function(e){k.click_change_qty(this.orderline,1,e)},this.discount_handler=function(e){k.click_discount(e)},this.medical.get_order()&&this.bind_order_events()},click_line:function(e,b){this.medical.get_order().select_orderline(e)},click_discount:function(e){var b=this,k=this.medical.get_order(),w=k.get_selected_orderline(),C=this.medical.get_cashier();this.gui.show_popup("popup-discount",{disc_perc:w.discount,disc_fix:w.discount_fixed,subtotal:w.get_all_prices().priceWithTaxBeforeDiscount,confirm:function(e,q){if(C&&0!=C.max_discount){if(e>C.max_discount){b.chrome.error_toast(c("You are not allowed to apply discount more than "+C.max_discount+" %"));return}var P=k.get_total_without_discount()*C.max_discount/100;if(q>P){b.chrome.error_toast(c("You are not allowed to apply discount more than "+P));return}}e?(w.set_fix_discount(0),w.set_discount(e)):(w.set_discount(0),w.set_fix_discount(q))}})},change_selected_order:function(){this.medical.get_order()&&(this.bind_order_events(),this.renderElement())},orderline_add:function(){this.renderElement("and_scroll_to_bottom")},orderline_remove:function(e){this.remove_orderline(e),this.update_summary()},orderline_change:function(e){this.rerender_orderline(e),this.update_summary()},bind_order_events:function(){var e=this.medical.get_order();e.unbind("change:client",this.update_summary,this),e.bind("change:client",this.update_summary,this),e.unbind("change",this.update_summary,this),e.bind("change",this.update_summary,this);var b=e.orderlines;b.unbind("add",this.orderline_add,this),b.bind("add",this.orderline_add,this),b.unbind("remove",this.orderline_remove,this),b.bind("remove",this.orderline_remove,this),b.unbind("change",this.orderline_change,this),b.bind("change",this.orderline_change,this)},render_orderline:function(e){var b=this,k=this.medical.get_order(),w=k.get_selected_orderline(),C=this.medical.config,q=a.render("OrderWidget.Orderline",{widget:this,line:e,order:k}),P=document.createElement("div");P.innerHTML=_.str.trim(q),(P=P.childNodes[0]).orderline=e,P.addEventListener("click",this.line_click_handler);var S=P.querySelector(".fa-minus");S&&S.addEventListener("click",this.minus_qty_handler);var x=P.querySelector(".fa-plus");x&&x.addEventListener("click",this.plus_qty_handler),P.querySelector(".fa-percent").addEventListener("click",this.discount_handler),P.querySelector(".v-content-handle").addEventListener("click",function(e){$(e.target).parents("li").find(".v-other-content").slideToggle()});var I=P.querySelector(".v-line-sessions");if(I&&I.addEventListener("click",function(k){b.gui.show_popup("popup-number",{title:c("Update Sessions"),value:e.session_count,confirm:function(e){w.set_session_count(e)}})}),C.enable_line_analytics){var E=P.querySelector(".v-line-analytic-account");E&&E.addEventListener("click",function(k){console.log("___ Open Analytic Account : ",e.get_analytic_acc_id(),e),b.gui.show_popup("popup-analytic-account",{value:e.analytic_account_id,orderline:e,confirm:function(b){e.set_analytic(b)}})});var E=P.querySelector(".v-line-analytic-tags");E&&E.addEventListener("click",function(k){console.log("___ Open Analytic Tags : ",e.analytic_tag_ids,e),b.gui.show_popup("popup-analytic-tags",{value:e.analytic_tag_ids,confirm:function(b){console.log("___ analytic_tag_ids value : ",b),e.set_analytic(!1,b)}})})}var E=P.querySelector(".v-line-duration");E&&E.addEventListener("click",function(k){b.gui.show_popup("time-input",{value:b.floatToHour(e.duration),confirm:function(b){var k=moment.duration(b).asMinutes();e.set_orderline_duration(k/60)}})});var E=P.querySelector(".v-sample-desc");if(E&&E.addEventListener("click",function(k){b.gui.show_popup("alert",{title:e.product.display_name,body:e.product.description})}),C.allow_price_change){var E=P.querySelector(".v-price-change");E&&E.addEventListener("click",function(k){b.gui.show_popup("popup-number",{title:c("Change Price"),value:parseFloat(e.price),confirm:function(k){var w=Number(k);if(w&&w<Number(e.price)){b.medical.chrome.error_toast("Price could not be less then base amount.");return}e.set_unit_price(w)}})})}if(C.enable_line_select_emp){var E=P.querySelector(".v-line-employee");E&&E.addEventListener("click",function(k){var w=e.get_line_employee_id(),C=e.get_multi_data().multi_resource_id,q=[];if(C){var P=_.findWhere(b.medical.db.all_resources,{id:C});_.each(P.emp_ids,function(e){var k=_.findWhere(b.medical.all_employees,{id:e});_.isEmpty(k)||q.push(k)})}b.gui.show_popup("popup-select-employee",{title:c("Change Employee"),value:w,line_resource_id:C,emp_list:q,confirm:function(k){e.set_line_employee_id(k),b.rerender_orderline(e)}})})}if(C.enable_line_consumable){var E=P.querySelector(".v-line-consumable");E&&E.addEventListener("click",function(k){b.gui.show_popup("popup-product-consumable",{title:c("Consumable Products"),value:e.orig_line_id,confirm:function(b){e.set_consumables(b)}})})}return e.node=P,P},click_change_qty:function(e,b,k){var e=this.medical.get_order().get_selected_orderline(),w=e.get_quantity()+b;0==w?e.set_quantity("remove"):e.set_quantity(w,!0)},remove_orderline:function(e){0===this.medical.get_order().get_orderlines().length?this.renderElement():e.node.parentNode.removeChild(e.node)},rerender_orderline:function(e){var b=e.node,k=this.render_orderline(e);b.parentNode.replaceChild(k,b)},replace:function(e){this.renderElement();var b=e[0];b.parentNode.replaceChild(this.el,b)},renderElement:function(e){var b=this.medical.get_order();if(b){var k=b.get_orderlines(),w=a.render("OrderWidget",{widget:this,order:b,orderlines:k}),C=document.createElement("div");C.innerHTML=_.str.trim(w);for(var q=(C=C.childNodes[0]).querySelector(".orderlines"),P=0,S=k.length;P<S;P++){var x=this.render_orderline(k[P]);q.appendChild(x)}this.el&&this.el.parentNode&&this.el.parentNode.replaceChild(C,this.el),this.el=C,this.update_summary()}},update_summary:function(){var e=this.medical.get_order();if(e.get_orderlines().length){var b=e?e.get_total_with_tax():0;e&&e.get_total_without_tax(),this.el.querySelector(".summary .total > .value").textContent=this.format_currency(b),this.el.querySelector(".summary .v-duration .value").textContent=e.get_total_duration_display(),this.el.querySelector(".summary .v-services .value").textContent=e.get_orderlines().length}},check_editable:function(e){console.log("___ is_editable : ",e,this.$(".v-insurance-check, .fa-minus, .fa-plus, .fa-percent").length,this.$el),e?this.$(".fa-minus, .fa-plus, .fa-percent").hide():this.$(".fa-minus, .fa-plus, .fa-percent").show()}}),u=o.ScreenWidget.extend({template:"AppointmentScreenWidget",events:_.extend({},o.ScreenWidget.prototype.events,{"click .js_select_categ":"onSelectCategory","click .v-product-box":"onSelectProduct","click .v-close":"onClose","click .v-save":"onSave","click .v-validate":"finalizeOrder","click .v-cancel":"cancelOrder","click .v-reset":"resetOrder","click .js_order_patient":"on_Patient","click .js_order_start_time":"on_Start_time","click .js_order_resource":"on_Resource","click .v-insurance-check":"onClickInsurance","click .js_product_search":"search_handler","click .js_product_clear_search":"clear_search","click .js_payment":"open_direct_payment","click .js_clinic":"_selectBranch","click .v-maximize":"_maximizeOrder","click .js_visit_type":"openVisitPopUp"}),init:function(){this._super.apply(this,arguments);var e=this;this.filter_categ_id=0,this.is_open=!1,this.product_list_limit=75,this.product_list=this.medical.db.all_products,this.is_readonly=!1;var b=null;this.search_handler=function(k){if("keypress"==k.type||46===k.keyCode||8===k.keyCode){clearTimeout(b);var w=this;b=setTimeout(function(){e.perform_search(e.filter_categ_id,w.value,13===k.which)},200)}}},_maximizeOrder:function(e){var b=$(e.currentTarget),k=$("#v_appointment_container"),w=k.find(".v-product-list-container"),C=k.find(".v-order-container");this.is_order_maximized?(w.removeClass("oe_hidden"),C.removeClass("col-md-12").addClass("col-md-4"),b.find("i").removeClass("fa-arrow-right").addClass("fa-arrow-left"),C.find(".v-orderline-container").height(400),this.is_order_maximized=!1):(w.addClass("oe_hidden"),C.removeClass("col-md-4").addClass("col-md-12"),b.find("i").removeClass("fa-arrow-left").addClass("fa-arrow-right"),C.find(".v-content-handle").click(),this.is_order_maximized=!0)},_selectBranch:function(){var e=this.medical.get_order(),b=[],k=this;_.each(this.medical.db.all_clinics,function(e){b.push({label:e.name,item:e})}),k.chrome.gui.show_popup("selection",{title:"Change Branch",list:b,is_selected:function(b){return b.id===e.get_clinic()},confirm:function(b){e.set_clinic(b.id),k.update_element("#span_clinic",b.name)}})},is_editable:function(){return!!this.is_readonly},check_editable:function(){this.is_editable();var e=this.medical.get_order();this.is_readonly?(this.$("#product-list, .v-order-control").css("pointer-events","none"),this.$(".v-save, .v-validate, .v-insurance-check").hide()):(this.$("#product-list, .v-order-control").css("pointer-events",""),this.$(".v-save, .v-validate, .v-insurance-check").show());var b=!0==e.is_readonly&&"cancel"!=e.state,k=!0==e.is_readonly&&"cancel"==e.state;this.$(".v-cancel").toggle(b),this.$(".v-reset").toggle(k)},finalizeOrder:function(){var e=this,b=this.medical.get_order(),k=this.options&&this.options.order_id||b.server_id;if(b.get_client(),b&&b.orderlines&&0==b.orderlines.length){this.chrome.error_toast(_("Atleast One Service Required."));return}if(b.is_readonly){this.chrome.error_toast(_("Appointment already validated."));return}this.sync_appointment().then(function(b){var w=e.medical.get_order(),C=w.get_client();if(k||_.each(b,function(e){e.ui_reference==w.name&&(k=e.id)}),w.id=k,w.partner_id=C.id,w.partner=C,!k){e.chrome.error_toast(c("Failed Saving an Appointment..."));return}var q={default_med_employee_id:e.medical.get_cashier().id};e.chrome.success_toast(c("Appointment Validating...")),e.blockUI(),e._rpc({model:"medical.order",method:"action_create_invoice_wrapper",args:[[k]],context:q}).then(function(b){e.chrome.unblockUI(),e.chrome.success_toast(c("Appointment Validated Successfully.")),b&&!b.partner&&b.partner_id&&b.partner_id.length>1&&(b.partner=e.medical.db.get_partner_by_id(b.partner_id[0]),w.partner_id=b.partner_id[0]),e.gui.show_screen("page_invoice",{"previous-screen":"calendar",invoice:b,order:w},!0)}).guardedCatch(function(b){console.error("_ error : ",b),e.chrome.unblockUI()})})},cancelOrder:function(){var e=this,b=this.medical.get_order(),k=this.options&&this.options.order_id||b.server_id;if(!k){this.chrome.error_toast(_("Save the Appointment First"));return}e.chrome.error_toast(c("Cancelling Appointment...")),this.blockUI(),this._rpc({model:"medical.order",method:"action_cancel_wrapper",args:[[k]]}).then(function(b){e.is_readonly=b.is_readonly,e.invoice_number=b.invoice_number,e.renderElement(),e.chrome.unblockUI(),e.chrome.error_toast(c("Appointment Cancelled Successfully.")),e.gui.close_popup()}).guardedCatch(function(b){console.error("_ error : ",b),e.chrome.unblockUI()})},resetOrder:function(){var e=this,b=this.medical.get_order(),k=this.options&&this.options.order_id||b.server_id;if(!k){this.chrome.error_toast(_("Save the Appointment First"));return}e.chrome.info_toast(c("Updating Server...")),this.blockUI(),this._rpc({model:"medical.order",method:"action_reset_wrapper",args:[[k]]}).then(function(b){e.is_readonly=b.is_readonly,e.invoice_number=b.invoice_number,e.chrome.unblockUI(),e.chrome.info_toast(c("Appointment settled to draft.")),e.gui.close_popup()}).guardedCatch(function(b){console.error("_ error : ",b),e.chrome.unblockUI()})},open_direct_payment:function(e){var b=this.medical.get_order();this.gui.show_popup("popup-register-payment",{order:b,partner:b.get_client()||{},ref:b.name,order_id:b.id||b.server_id,amount_total:b.get_total_with_tax()})},onClickInsurance:function(){var e=this.medical.get_order(),b=e.get_client();if(console.log("___ onClickInsurance : ",e.partner_id,b,e.insurance_card_id,e),!b||!b.id){console.info("___ Patient Not Found : ",e.partner_id,b,e),this.chrome.error_toast(c("Please select the Patient First."));return}if(!e||!e.insurance_card_id){console.info("___ Insurance Card ID Not Found : ",e.insurance_card_id,e.insurance_card,e),this.chrome.error_toast(c("Please select the Insurance Card first.")),this._checkInsuranceCard(function(){e._checkOrderInsurance()});return}return e._checkOrderInsurance()},update_element:function(e,b){this.$(e).html(b)},start:function(){this._super.apply(this,arguments),this.order_widget=new p(this,{}),this.order_widget.replace(this.$("#js_order_widget")),this.action_buttons={};for(var e=s,b=0;b<e.length;b++){var k=e[b];if(!k.condition||k.condition.call(this)){var w=new k.widget(this,{});w.appendTo(this.$(".v-order-control")),this.action_buttons[k.name]=w}}_.size(this.action_buttons)&&this.$(".v-order-control").removeClass("oe_hidden")},show:function(){this._super.apply(this,arguments),this.is_open=!0;var e=this.medical.get_order();this.is_readonly=e.is_readonly,this.$(".js_product_search").val()&&this.clear_search(),this.renderOrderDetails(),this.check_editable()},_checkInsuranceCard:function(e){var b=this,k=this.medical.get_order(),w=k&&k.get_client();if(!w){this.chrome.error_toast(c("Please select the Patient First."));return}var C=_.map(w.ins_running_card_ids,function(e){return b.medical.insurance_card_by_id[e]});return b.gui.show_popup("popup-select-insurance",{order:k,insurance_cards:C,selected_card:_.findWhere(C,{id:k.insurance_card_id}),confirm:function(b){b&&b.name&&e&&e()}})},beforeSave:function(e){return e},sync_appointment:function(e){e||(e=this.medical.get_order());var b=this,k=new $.Deferred;return(e=this.beforeSave(e),console.log("___ onSave order : ",e),e.validate_order())?(this.chrome.info_toast(c("Updating Server..."),c("Appointment")),this.medical.push_order(e).then(function(e){return console.log("___ On Save Returned result : ",e),b.unblockUI(),b.chrome.info_toast(c("Appointment updated successfully."),c("Appointment")),k.resolve(),e}).guardedCatch(function(e){console.error("_ error : ",e),b.chrome.unblockUI()})):(b.unblockUI(),k.fail())},onSave:function(e){this.blockUI();var b=this;return this.sync_appointment().then(function(e){b.onClose()})},onClose:function(){this.is_open=!1;var e=this.medical.get_order();e&&e.destroy(),this.gui.show_screen("calendar")},renderOrderDetails:function(){var e=this.medical.get_order(),b=e.get_client(),k=e.get_resource_display(),w=e.get_start_time_display(),C=e.get_insurance_card_display(),q=e.get_pricelist(),P="<small class='badge badge-secondary ml-1' style='font-size: 12px;'>"+e.get_state_display()+"</small>";this.update_element("#span_order_name",e.name+" "+P),b&&this.update_element("#span_order_patient",b.name),k&&this.update_element("#span_order_resource",k),w&&this.update_element("#span_order_start_time",w),C&&this.update_element("#span_insurance_card",C),q&&this.update_element("#js_pricelist .js_name",q.name);var S=e.get_clinic();return S&&this.update_element("#span_clinic",this.medical.db.clinic_by_id[S].name),e},renderElement:function(){this._super.apply(this,arguments),this.renderProducts(),this.el.querySelector(".searchbox input").addEventListener("keypress",this.search_handler),this.el.querySelector(".searchbox input").addEventListener("keydown",this.search_handler)},onSelectCategory:function(e){var b=this,k=$(e.currentTarget),w=k.data("categ_id"),C=this.$(".v-btn-child-categs"),q=this.el.querySelector(".searchbox input");if(this.filter_categ_id!=w){if(0==w)this.perform_search(w,q.value,13===e.which),C.html("");else if(w>0){this.perform_search(w,q.value,13===e.which);var P=this.medical.db.get_category_childs_ids(w),S=this.medical.db.category_by_id,x="";_.each(P,function(e){x+=a.render("Session.Category",{widget:b,categ_id:e,categ_by_id:S})}),C.html(x)}this.filter_categ_id=w,k.addClass("active").siblings().removeClass("active")}},onSelectProduct:function(e){var b=$(e.currentTarget).data("product"),k=this.medical.db.product_by_id[b],w=this.medical.get_order();if(this.medical.config.restrict_duplicate_product){for(var C=w.get_orderlines(),q=0,P=C.length;q<P;q++)if(C[q].product.id==b){this.chrome.error_toast("Same product/service already selected.","Restricted");return}}if(w.add_product(k),"service"==k.type&&this.medical.config.allow_multi_appointments){var S=w.get_selected_orderline(),x=S.get_multi_data(),I=w.get_clinic(),E=this.medical.db.clinic_by_id[I].resources;this.gui.show_popup("popup-multi-appointment",{start_time:x.multi_start_time,resource_id:x.multi_resource_id,orderline:S,resource_list:E})}},on_Patient:function(){this.gui.show_screen("patient_list",{back_screen:"appointment",set_customer:!0})},on_Start_time:function(){var e=this,b=this.medical.get_order();e.gui.show_popup("datetime-input",{title:"Set Appointment Date/Time",value:b.get_start_time_display(),confirm:function(k){b.set_start_time(e.getUTC(k)),e.update_element("#span_order_start_time",b.get_start_time_display())}})},on_Resource:function(){var e=this,b=this.medical.get_order();console.log("_ order.resource_id : ",b.resource_id,b.insurance_card),e.chrome.gui.show_popup("popup-ref-doctor",{value:b.get_resource_id(),confirm:function(k){if(b.set_resource_id(k),k){var w=_.findWhere(e.medical.db.all_resources,{id:parseInt(k)});if(_.isEmpty(b.insurance_card)){var C={};C=!_.isEmpty(w.pricelist_id)&&w.pricelist_id.length?_.findWhere(e.medical.pricelists,{id:w.pricelist_id[0]}):e.medical.default_pricelist,_.isEmpty(C)||(b.set_pricelist(C),e.update_element("#js_pricelist .js_name",C.name),e.gui.current_screen.renderProducts(C))}e.update_element("#span_order_resource",w.name)}}})},openVisitPopUp:function(){var e=this,b=this.medical.get_order();console.log("appt visit visited"),e.chrome.gui.show_popup("popup-ref-visit",{value:b.get_resource_id(),confirm:function(k){var w=_.findWhere(e.medical.visit_options,{id:parseInt(k)});b.set_visit_option(w.id),e.update_element("#span_visit_type",w.name)}})},clear_search:function(){this.$(".js_product_search").val()&&(this.$(".js_product_search").val(""),this.product_list=this.medical.db.all_products,this.renderProducts())},perform_search:function(e,b,k){var w;b?(w=this.medical.db.search_product_in_category(e,b),k&&1===w.length?(this.medical.get_order().add_product(w[0]),this.clear_search()):this.set_product_list(w,b)):(w=this.medical.db.get_product_by_category(e),this.set_product_list(w,b))},set_product_list:function(e,b){this.product_list=e,this.search_word=!!b&&b,this.renderProducts()},renderProducts:function(e){var b=this.medical.get_order();e=e||b.get_pricelist()||this.medical.default_pricelist,this.$("#product-list").html(a.render("ProductList",{widget:this,pricelist:e,product_limit:this.product_list_limit}))}});i.define_screen({name:"appointment",widget:u});var h=t.PopupWidget.extend({template:"PopupRegisterPayment",events:_.extend({},t.PopupWidget.prototype.events,{"click .cancel":"click_cancel","click .v-payment-reset":"render_reset_payment","click .v-payment-register":"register_payment"}),show:function(){this._super.apply(this,arguments),this.partner=this.options.partner,this.order=this.options.order,this.partner_id=this.partner&&this.partner.id||this.options.partner_id,!this.partner&&this.partner_id&&(this.partner=this.db.get_partner_by_id(this.partner_id)),this.amount_total=this.options.amount_total,this.order_id=this.options.order_id,this.ref=this.options.ref,console.log("___ this.options : ",this.partner_id,this.options,this.partner),this.renderElement()},prepare_payment_lines:function(){var e=this,b=[],k=!1,w=this.medical.config.current_session_id&&this.medical.config.current_session_id.length&&this.medical.config.current_session_id[0];return _.each(this.$el.find("div.v-payment-line"),function(C){var q=$(C).find("input.v-cash-register"),P=parseFloat(q.val()),S=parseInt(q.attr("name"));if(P){var x="";P&&$(C).find("input.v-cash-ref").length>0&&(x=$(C).find("input.v-cash-ref").val(),k=_.isEmpty(x)),b.push({amount:P,journal_id:S,communication:x||c("Advance Payment"),partner_id:e.partner_id||e.partner&&e.partner.id,medical_order_id:e.order_id,session_id:w,branch_id:e.medical.get_clinic().id})}}),console.log("Payment Line : ",b),[b,k]},register_payment:function(){var e=this,b=e.medical.get_clinic().id||!1,k=this.prepare_payment_lines(),w=k[0],C=k[1],q={default_med_employee_id:e.medical.get_cashier().id,default_branch_id:b};if(C){e.chrome.warning_toast(c("Reference number is required."));return}this.chrome.blockUI(),this._rpc({model:"medical.order",method:"register_payment_from_ui",args:[[this.order_id],w,""],context:q}).then(function(b){e.chrome.unblockUI(),e.chrome.success_toast(c("Payment added Successfully.")),e.gui.close_popup(),e.options.confirm&&e.options.confirm()}).guardedCatch(function(b){console.error("_ error : ",b),e.chrome.unblockUI()})},render_reset_payment:function(e){this.$el.find(".v-payment-method input").val(""),this.$el.find(".v-payment-method input:first").focus()},print_appoint_adv_report:function(e){this.chrome.print_report(this.report_tags.payment+"/"+e,"qweb-pdf")}});i.define_popup({name:"popup-register-payment",widget:h});var m=t.PopupWidget.extend({},{template:"PopupOrderDetails",show:function(){this._super.apply(this,arguments),this.order=this.options.order,this.partner=this.order.partner,this.calendar_widget=this.options.calendar},events:_.extend({},t.PopupWidget.prototype.events,{"click .v-partner-edit":"edit_partner","click .cancel":"click_cancel","click .v-order-delete":"remove_order","click .v-order-done":"done_order","click .v-order-edit":"edit_order","click .v-order-invoice":"open_invoice_screen","click .v-order-validate":"finalizeOrder","click .v-order-duplicate":"duplicate_order","click .v-order-waiting-list":"order_to_waiting","click .appointment-state .btn-state":"change_order_state","click .show-appointments":"open_appointments","click .v-credit-payment":"open_payment_popup","click .v-order-cut":"cut_order","click .create-reminder":"create_reminder","click .v-order-print":"print_report","click .v-note-save":"write_order_note","click .v-direct-payment":"open_direct_payment","click .h-chatter":"open_chatter_popup","click .v-patient-sticker":"print_patient_sticker","click .log-handover-file-on":"log_handover_file_on","click .log-print-file-on":"log_print_file_on","click .h-chatter":"open_chatter_popup","change .sequence-no":"_onChangeSequenceNo","click .btn-rearrange-sequence":"_onClickBtnReArrangeSequence","click .btn-app-print":"print_sel_report","click .nav-item":"_onClickTabLink","click .edit-complain":"_onClickEditComplain","click .create-complain":"_onClickCreateComplain","click .v-test-print":"_onTestPrint","click .v-print-sample":"_onSamplePrint","click .v-print-sample-barcode":"_onBarcodePrint","click .v-print-test-result":"_onPrintAllResult","click .v-line-print-sample":"_onLineSamplePrint","click .v-line-print-sample-barcode":"_onLineBarcodePrint","click .send-msg":"_sendMessage","click .send-email":"_sendEmail"}),_sendMessage:function(e){var b=this,k=$(e.currentTarget).data("id"),k=parseInt(k);this._rpc({model:"medical.order",method:"send_by_sms",args:[[parseInt(k)]]}).then(function(e){e&&e.success?b.chrome.info_toast(c("SMS has been sent successfully")):b.chrome.error_toast(e.error,c("Somethig went wrong..."))})},_sendEmail:function(e){var b=this,k=$(e.currentTarget).data("id"),k=parseInt(k);this._rpc({model:"medical.order",method:"send_by_email",args:[[parseInt(k)]]}).then(function(e){e&&e.success?b.chrome.info_toast(c("Email has been sent successfully")):b.chrome.error_toast(e.error,c("Somethig went wrong..."))})},_onLineSamplePrint:function(e){var b=$(e.currentTarget).data("testids");b&&this.chrome.print_report("medical_lab.report_patient_sticker_lab_sample/"+b,"qweb-pdf")},_onLineBarcodePrint:function(e){var b=$(e.currentTarget).data("testids");b&&this.chrome.print_report("medical_lab.report_patient_barcode_sample/"+b,"qweb-pdf")},_onTestPrint:function(e){var b=this,k=$(e.currentTarget).data("testids");k&&b._rpc({model:"medical.lab.test",method:"update_to_handover",args:[[k]]}).then(function(e){b.chrome.unblockUI(),b.chrome.print_report("medical_lab.report_medical_patient_labtest/"+k,"qweb-pdf")}).guardedCatch(function(e){b.chrome.unblockUI()})},_onSamplePrint:function(){var e=this.order.id;e&&this.chrome.print_report("medical_lab.report_patient_sticker_app_sample/"+e,"qweb-pdf")},_onBarcodePrint:function(){var e=this.order.id;e&&this.chrome.print_report("medical_lab.report_medical_all_lab_barcode/"+e,"qweb-pdf")},_onPrintAllResult:function(){var e=this.order.id;if(e){var b=this.order.medical_lab_test_ids;b&&this._rpc({model:"medical.lab.test",method:"update_to_handover",args:[b]}),this.chrome.print_report("medical_lab.report_medical_app_test_result/"+e,"qweb-pdf")}},finalizeOrder:function(){var e=this,b=this.options.order,k={default_med_employee_id:e.medical.get_cashier().id};e.chrome.success_toast(c("Appointment Validating...")),e.blockUI(),e._rpc({model:"medical.order",method:"action_create_invoice_wrapper",args:[[b.id]],context:k}).then(function(k){e.chrome.unblockUI(),e.chrome.success_toast(c("Appointment Validated Successfully.")),k&&!k.partner&&k.partner_id&&k.partner_id.length>1&&(k.partner=e.medical.db.get_partner_by_id(k.partner_id[0]),b.partner_id=k.partner_id[0]),e.gui.show_screen("page_invoice",{"previous-screen":"calendar",invoice:k,order:b},!0)}).guardedCatch(function(b){e.chrome.unblockUI()})},click_cancel:function(){this._super.apply(this,arguments),this.calendar_widget&&this.calendar_widget.calendar.refetchEvents()},print_sel_report:function(e){var b=this.$(".v-report-selection").val();this.print_selected_report(b,this.options.order)},_onChangeSequenceNo:function(e){var b=this;e.preventDefault();var k=this.options.order;this._rpc({model:"medical.order",method:"write",args:[[k.id],{sequence_no:parseInt(e.currentTarget.value)}]}).then(function(e){b.chrome.success_toast(c("Sequence is updated successfully."))})},_onClickBtnReArrangeSequence:function(e){var b=this;e.preventDefault();var k=this.options.order;this._rpc({model:"medical.order",method:"reset_sequence_afterwards_appointments",args:[[k.id]]}).then(function(e){b.chrome.success_toast(c("Sequence is updated successfully for afterwards appointments."))})},print_patient_sticker:function(){var e=this.partner;e&&this.chrome.print_report("medical_report.report_patient_sticker/"+e.id,"qweb-pdf")},open_chatter_popup:function(e){this.gui.show_popup("popup-mail-chatter",{parent:this,order:this.options.order})},log_time:function(e){var b=this.options.order;return this._rpc({model:"medical.order",method:"log_time",args:[[b.id],e]}).then(function(k){return b[e]=k,k})},log_handover_file_on:function(e){var b=this;this.options.order.handover_file_on?alert("Already logged time for file handling."):b.log_time("handover_file_on").then(function(e){b.chrome.success_toast(c("Logged time for sample."))})},log_print_file_on:function(e){var b=this,k=this.options.order;b.log_time("printed_file_on"),k.printed_file_on||b.log_time("printed_file_on").then(function(e){b.chrome.success_toast(c("Logged time for file Printing."))}),b.print_patient_sticker()},open_direct_payment:function(e){this.gui.show_popup("popup-register-payment",{order:this.order,partner:this.partner,ref:"Advance Payment",order_id:this.order&&this.order.id,amount_total:this.order&&this.order.amount_due})},write_order_note:function(e){var b=this,k=this.options.order,w=$(e.currentTarget).siblings("#text_order_note").val();this.chrome.info_toast(c("Updating Note... !"),c("Appointment")),k.id&&this._rpc({model:"medical.order",method:"write",args:[[k.id],{note:w}]}).then(function(){b.chrome.success_toast(c("Note updated successfully... !"),c("Appointment")),b.click_cancel()})},print_report:function(e){var b=$(e.currentTarget).attr("data-order");b&&this.chrome.print_report("medical_report.medical_appointment_report_template/"+b,"qweb-pdf")},open_payment_popup:function(){this.medical.open_aging_popup(this.partner.id)},open_appointments:function(){var e=this;this._rpc({route:"/partner/events",params:{partner_id:this.partner.id}}).then(function(b){b&&b.length&&e.gui.show_popup("partner-appointments",{events_data:b})})},renderElement:function(){this._super.apply(this,arguments);var e=this.options.order;e&&e.state&&(this.$el.find(".appointment-state .btn-state[data-state='"+e.state+"']").removeClass("btn-secondary").addClass("btn-info"),_.contains(["draft","late","confirmed","arrived"],e.state)||(this.$el.find(".sequence-no").attr("disabled","disabled"),this.$el.find(".btn-rearrange-sequence").attr("disabled","disabled")))},toPosOrder:function(e,b){return this.medical.toPosOrder(e,b)},cut_order:function(){var e=this.options.order;if(!_.isEmpty(e)){if(e.invoice_state&&"posted"==e.invoice_state){this.chrome.info_toast(c("Cannot move this appointment, Invoice is already Validated !"),c("Invalid"));return}var b=this.toPosOrder(e);this.chrome.info_toast(c("Click on the calendar where you need to Move !"),c("Move Appointment")),this.medical.set_order(b),this.medical.move_order=!0,this.medical.duplicate_order=!1,this.click_cancel(),this.gui.show_screen("calendar")}},edit_order:function(){var e=this.options.order;if(!_.isEmpty(e)){var b=this.toPosOrder(e);this.medical.set_order(b),this.gui.show_screen("appointment")}},open_invoice_screen:function(){this.chrome.blockUI();var e=this,b=this.options.order;_.isEmpty(b)?e.chrome.unblockUI():this._rpc({route:"/event/invoice",params:{order_id:b.id}}).then(function(k){k&&!k.partner&&k.partner_id&&k.partner_id.length>1&&(k.partner=e.medical.db.get_partner_by_id(k.partner_id[0])),e.gui.show_screen("page_invoice",{"prev-screen":"calendar",invoice:k,order:b},!0),e.chrome.unblockUI()})},duplicate_order:function(){var e=this,b=this.options.order;if(!_.isEmpty(b)){if(!_.isEmpty(b.insurance_card_id)){this.chrome.info_toast(c("Insurance appointments cannot be duplicated due to Insurance Information are unique !"),c("Restricted"));return}var k=e.toPosOrder(b,"duplicate");this.chrome.info_toast(c("Duplicating..."),c("Please click on Save to submit the appointment !")),e.medical.set_order(k),e.medical.duplicate_order=!0,e.medical.move_order=!1,this.click_cancel(),e.gui.show_screen("appointment")}},order_to_waiting:function(){var e=this.options.order;if(!_.isEmpty(e)){var b={};b.medical_order_id=e.id,b.resource_id=e.resource_id[1],b.date=moment(e.start_time).format("YYYY-MM-DD"),b.patient_id=e.partner_id[1],b.patient_mobile=e.partner.mobile||"",b.order_lines=e.order_lines,this.gui.show_popup("waiting-add",{order:b,title:"Convert to Waiting List",disabled_fields:["resource_id","patient_id","patient_mobile"],reload:!1})}},done_order:function(){},edit_partner:function(){var e=this.options.order&&this.options.order.partner&&this.options.order.partner.id;this.gui.show_screen("patient_list");var b=this.medical.db.get_partner_by_id(e);this.gui.current_screen.display_client_details("edit",b)},remove_order:function(){var e=this,b=this.order&&this.order.id;if(confirm(c("Are you sure ?")))return this._rpc({model:"medical.order",method:"unlink",args:[[b]]}).then(function(){e.gui.close_popup(),e.calendar_widget&&e.calendar_widget.calendar.refetchEvents()})},change_order_state:function(e){var b=this,k=this.options.order,w=$(event.srcElement),C=w.data("state");if(C&&C!=k.state){var q=$.Deferred();if("cancel"===C){if("posted"==k.invoice_state){b.chrome.error_toast(c("Appointment has posted Invoice. Please cancel the Invoice first."),c("Invalid"));return}b.gui.show_popup("textarea_radio",{title:c("Add Note"),value:"",checkbox_title:c("Is canceled by CCT ?"),confirm:function(e,k){if(!e||e.length<=5){b.chrome.error_toast(c("Cancellation reason required. (Min. 5 Charactors.)"));return}q.resolve(e,k)},cancel:function(){q.reject()}})}else q.resolve();q.done(function(e,q){w.siblings(".span-process").removeClass("oe_hidden");var P={cancel_reason:e||"",canceled_by_cct:q};P.state=C,b._rpc({model:"medical.order",method:"write",args:[[k.id],P]}).then(function(e){e&&(w.siblings(".btn-info").removeClass("btn-info").addClass("btn-secondary"),w.removeClass("btn-secondary").addClass("btn-info"),k.state=C,"arrived"==k.state&&(k.file_no="TEMP-FIX",k.file_no2="TEMP-FIX"),"cancel"===C&&b.click_cancel(),_.contains(["draft","late","confirmed","arrived"],k.state)?(b.$el.find(".sequence-no").removeAttr("disabled"),b.$el.find(".btn-rearrange-sequence").removeAttr("disabled")):(b.$el.find(".sequence-no").attr("disabled","disabled"),b.$el.find(".btn-rearrange-sequence").attr("disabled","disabled")))})})}},getColor:function(e){var b=_.findWhere(this.medical.db.states_by_id,{name:e});return b&&b.s_color||"#FFF"},create_reminder:function(){var e=this.options.order;if(!_.isEmpty(e)){var b={};b.appointment_id=[e.id,e.name],this.gui.show_popup("reminder-add",{line:b})}},_onClickTabLink:function(e){e.preventDefault(),$(e.currentTarget).tab("show")},_onClickEditComplain:function(e){e.preventDefault();var b=parseInt($(e.currentTarget).data("complain_id")),k=_.filter(this.order.complains,function(e){return e.id==b})[0];this.medical.gui.show_popup("complain-popup",{complain_id:b,complain:k,confirm:this._updateComplain})},_onClickCreateComplain:function(e){e.preventDefault(),this.medical.gui.show_popup("complain-popup",{complain_id:!1,complain:{appointment_id:[this.order.id]},confirm:this._updateComplain})},_updateComplain:function(e){var b="create",k=[],w=parseInt(e.id),C=e.old_data;delete e.old_data,w?(e.state!=C.state&&"resolved"==e.state&&(e.resolved_eid=this.medical.get_cashier().id),b="write",k=[[w],e]):(e.create_eid=this.medical.get_cashier().id,"resolved"==e.state&&(e.resolved_eid=e.create_eid),delete e.id,k=[e]),this._rpc({model:"patient.complain",method:b,args:k}),this.medical.gui.close_popup()}});i.define_popup({name:"popup-appointment-details",widget:m});var f=t.PopupWidget.extend({template:"CreateInsurancePopupWidget",events:_.extend({},t.PopupWidget.prototype.events,{"change .main_company_id":"onchangeMainCompany","change .insurance_company_id":"onchangeSubCompany"}),onchangeSubCompany:function(e){var b=parseInt($(e.currentTarget).select2("val")),k=_.filter(this.medical.insurance_schemes,function(e){return e.insurance_company_id&&e.insurance_company_id[0]==b});k=_.map(k,function(e){return{id:e.id,text:e.name}});var w=this.$(".pricelist_id");w.select2({data:k}),this.card.pricelist_id&&w.select2("val",this.card.pricelist_id[0])},onchangeMainCompany:function(e){var b=parseInt($(e.currentTarget).select2("val")),k=_.filter(this.medical.ins_sub_companies,function(e){return e.parent_id&&e.parent_id[0]==b}),w=_.map(k,function(e){return{id:e.id,text:e.name}}),C=this.$(".insurance_company_id");C.select2({data:w}),this.card.insurance_company_id&&C.select2("val",this.card.insurance_company_id[0]);var q=_.filter(this.medical.insurance_schemes,function(e){return e.insurance_parent_id&&e.insurance_parent_id[0]==b});q=_.map(q,function(e){return{id:e.id,text:e.name}});var P=this.$(".pricelist_id");P.select2({data:q}),this.card.pricelist_id&&P.select2("val",this.card.pricelist_id[0])},show:function(){this._super.apply(this,arguments),this.order=this.options.order||this.medical.get_order(),this.card=this.options.card||{},this.partner=this.options.partner,this.renderElement();var e=_.map(this.medical.ins_main_companies,function(e){return{id:e.id,text:e.name}}),b=this.$(".main_company_id");b.select2({data:e}),this.card.main_company_id&&(b.select2("val",this.card.main_company_id[0]),b.trigger("change"))},click_confirm:function(e){var b=this;if(this.medical.get_order(),this.$("form")[0].checkValidity()){var k={partner_id:this.partner.id},w=!1;if(_.each(this.$("input"),function(e){if(e.name){var b=e.value;b&&$(e).hasClass("v-int")&&(b=parseInt(b)),b||(w=!0,$(e).css("border","1px solid red").focus()),k[e.name]=b}}),w){this.medical.chrome.error_toast(c("All Inputs are required."));return}this.medical.chrome._rpc({model:"insurance.card",method:"create_from_medical_ui",args:[k]}).then(function(e){b.medical.insurance_card_by_id[e.id]=e;var k=b.medical.db.get_partner_by_id(e.partner_id[0]);_.include(k.ins_running_card_ids,e.id)||k.ins_running_card_ids.push(e.id),b.gui.close_popup(),b.options.confirm&&b.options.confirm.call(this,e)})}}});i.define_popup({name:"popup-create-insurance",widget:f});var g=t.PopupWidget.extend({template:"SelectInsurancePopupWidget",events:_.extend({},t.PopupWidget.prototype.events,{"click .confirm":"click_confirm","click .v-add-card":"clickCreateNew"}),clickCreateNew:function(){this.medical.gui.show_popup("popup-create-insurance",{partner:this.medical.get_order().get_client()})},show:function(){this._super.apply(this,arguments),this.order=this.options.order,this.insurance_cards=this.options.insurance_cards,this.selected_card=this.options.selected_card,this.partner_id=this.order.get_client()},click_confirm:function(e){var b=Number($(e.target).data("insurance")),k=_.findWhere(this.options.insurance_cards,{id:b});k&&this.order.set_insurance_card(k),this.gui.close_popup(),this.options.confirm&&this.options.confirm.call(this,k)}});i.define_popup({name:"popup-select-insurance",widget:g});var v=t.PopupWidget.extend({template:"InsuranceCoverPopupWidget",events:_.extend({},t.PopupWidget.prototype.events,{"click .confirm":"click_confirm","click .v-upd-deductible":"checkInsUpdates","click .v-add-card":"clickCreateNew","click .v-change-card":"clickChangeCard"}),clickCreateNew:function(){this.medical.gui.show_popup("popup-create-insurance",{partner:this.medical.get_order().get_client()})},clickChangeCard:function(){var e=this,b=this.medical.get_order(),k=b&&b.get_client();if(!k){this.chrome.error_toast(c("Please select the Patient First."));return}var w=_.map(k.ins_running_card_ids,function(b){return e.medical.insurance_card_by_id[b]});return e.gui.show_popup("popup-select-insurance",{order:b,insurance_cards:w,selected_card:_.findWhere(w,{id:b.insurance_card_id})||{}})},checkInsUpdates:function(){var e=this,b={},k=this.$("tbody tr"),w=e.options.insurance_card.id;return _.each(k,function(e){var k=$(e),w=k.data(),C=Number(k.find(".approved_price_unit").val()),q=Number(w.price_unit),P=k.find(".is_insurance_applicable").prop("checked"),S=parseInt(w.qty),x=w.product;C==q&&(C=0),b[x]?b[x].qty=b[x].qty+S:b[x]={qty:S,actual_amt:q,approved_amt:C,is_insurance_applicable:P}}),this.medical._rpc_check_insurance_wrapper(w,b).then(function(b){e.options.result_lines=b.lines,e.options.result_by_product=b.result_by_product,e.final_result=b,e.renderCoverLine()})},show:function(){this._super.apply(this,arguments),this.order=this.medical.get_order()},renderCoverLine:function(){var e=this,b="",k={tot_actual:0,tot_approved:0,tot_approved_qty:0,tot_ins_claim:0,tot_patient_share:0,tot_payable:0};_.each(this.options.result_lines||[],function(w){w.result.pricelist_item_id&&(b=b+"\n"+a.render("InsuranceCoverPopupWidget.InsCoverLine",{widget:e,line:w}),k.tot_actual+=w.result.price_unit_orig,k.tot_approved+=w.result.approved_price_unit,k.tot_approved_qty+=w.result.approved_price_unit*w.qty,k.tot_ins_claim+=w.result.ins_price_unit*w.qty,k.tot_patient_share+=w.result.price_unit*w.qty,k.tot_payable+=w.result.payable_price_unit*w.qty)}),this.$(".table-ins-check tbody").html(b),this.$(".table-ins-check tfoot .tot_actual").html(e.format_currency_no_symbol(k.tot_actual)),this.$(".table-ins-check tfoot .tot_approved").html(e.format_currency_no_symbol(k.tot_approved)),this.$(".table-ins-check tfoot .tot_approved_qty").html(e.format_currency_no_symbol(k.tot_approved_qty)),this.$(".table-ins-check tfoot .tot_ins_claim").html(e.format_currency_no_symbol(k.tot_ins_claim)),this.$(".table-ins-check tfoot .tot_patient_share").html(e.format_currency_no_symbol(k.tot_patient_share)),this.$(".table-ins-check tfoot .tot_payable").html(e.format_currency_no_symbol(k.tot_payable))},renderElement:function(){this._super.apply(this,arguments),this.renderCoverLine()},click_confirm:function(e){var b=this.medical.get_order(),k={};_.each(this.$(".ins-ref-text"),function(e){k[e.name]=e.value}),b.set_insurance_cover(this.options.result_by_product,k),this.gui.close_popup(),this.options.confirm&&this.options.confirm.call(this,card)}});i.define_popup({name:"popup-insurance-cover",widget:v});var y=l.extend({template:"PricelistListBtn",button_click:function(){var e=this,b=this.medical.get_order(),k=[],w=this.medical.pricelists;_.each(w,function(e){k.push({label:e.name,item:e.id})}),this.medical.config.pricelist_need_password?e.gui.select_employee({security:!0,current_employee:e.medical.get_cashier(),title:c("Need Manager Password"),only_managers:!1}).then(function(C){e.gui.show_popup("selection",{title:c("Please select a pricelist"),list:k,is_selected:function(e){return e===b.get_pricelist().id},confirm:function(k){var C=_.findWhere(w,{id:k});b.set_pricelist(C),e.gui.current_screen.renderOrderDetails(b),e.gui.current_screen.renderProducts(C)}})}):e.gui.show_popup("selection",{title:c("Please select a pricelist"),list:k,is_selected:function(e){return e===b.get_pricelist().id},confirm:function(k){var C=_.findWhere(w,{id:k});b.set_pricelist(C),e.gui.current_screen.renderOrderDetails(b),e.gui.current_screen.renderProducts(C)}})}});
    return d({
        name: "app_pricelist",
        widget: y,
        condition: function() {
            return this.medical.pricelists.length > 1
        }
    }), {
        AppointmentScreenWidget: u,
        OrderWidget: p,
        RegisterPayment: h,
        PopupOrderDetails: m,
        CreateInsurancePopup: f,
        SelectInsurancePopup: g,
        InsuranceCoverPopup: v,
        ActionButtonWidget: l,
        define_action_button: d
    }
});